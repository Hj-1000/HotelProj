<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>[[${hotelDTO.hotelName}]], [[${hotelDTO.hotelLocation}]] í˜¸í…”</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/b17b1596b8.js" crossorigin="anonymous"></script>
    <link rel ="stylesheet" href="/assets/fonts/fontawesome-all.min.css">
    <link rel ="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel ="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">

    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© ì•„ì´ì½˜ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">

    <link rel="stylesheet" th:href="@{/css/user.css}">
    <link rel="stylesheet" th:href="@{/css/roomList.css}">

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        .wrapper {
            min-height: 100vh;  /* ë·°í¬íŠ¸ ë†’ì´ë§Œí¼ ìµœì†Œ í™•ë³´ */
            display: flex;
            flex-direction: column;
        }

        .content {
            flex: 1;  /* ì»¨í…ì¸ ê°€ ëŠ˜ì–´ë‚˜ë©´ í‘¸í„°ê°€ ë°€ë¦¬ì§€ ì•Šë„ë¡ ì„¤ì • */
        }

        .footer {
            width: 100%;
            background-color: #f8f9fa;  /* í•„ìš”ì— ë”°ë¼ ë°°ê²½ìƒ‰ ì¶”ê°€ */
            padding: 10px;
        }

        .hotel-images {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
            height: 400px;
            /*border: 1px solid purple;*/
        }

        .hotel-images img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
            /*border:1px solid orange;*/
        }

        .banner-img123-box {
            margin-top: 50px;
            width: 930px;
            height: auto;
            margin-bottom: -5px;
        }
        .banner-img123 {
            width: 100%;
        }

        .hotel-images img:first-child {
            grid-row: span 2;
        }

        .image-box {
            width:100%;
            height:230px;
            overflow:hidden;
        }

        .rooms-img {
            width:100%;
            height:100%;
            object-fit:cover;
        }

        /* ë³„ì  ë³„ë„ ìƒ‰ìƒ ì ìš© */
        .rating-5 { color: gold !important;}
        .rating-4 { color: green !important;}
        .rating-3 { color: blue !important;}
        .rating-2 { color: orange !important;}
        .rating-1 { color: red !important;}
    </style>


    <script th:inline="javascript">

        window.onload = function() {

            // ì„¸ì…˜ì—ì„œ message ê°’ì„ ê°€ì ¸ì˜´
            var message = [[${message}]];

            // messageê°€ nullì´ ì•„ë‹ˆë©´ ì•Œë¦¼ì°½ì„ ë„ìš°ê³  ì„¸ì…˜ì—ì„œ ì‚­ì œ
            if (message !== null && message !== '') {
                alert(message);
            }

            var hotelId = $(".likeBtn").data("hotel-id"); // HTMLì—ì„œ ì•ˆì „í•˜ê²Œ hotelId ê°€ì ¸ì˜¤ê¸°
            console.log("hotelId from data attribute:", hotelId); // âœ… ê°’ì´ ìˆ«ìë¡œ ë‚˜ì˜¤ëŠ”ì§€ í™•ì¸

            if (!hotelId || isNaN(hotelId)) {
                console.error("ì˜ëª»ëœ hotelId:", hotelId);
                return;
            }

            //ë¹„íšŒì›ìš© ìŠ¤í¬ë© ë²„íŠ¼(ë¡œê·¸ì¸í•˜ë©´ ì•ˆë³´ì„)
            var nya = $(".nya")
            nya.show()

            var url = "/like/check/" + hotelId

            $.ajax({
                url: url,
                type: "GET",
                data: { hotelId: hotelId },
                success: function (isLiked) {
                    console.log("ì°œ ì—¬ë¶€ í™•ì¸ ê²°ê³¼:", isLiked); // âœ… true ë˜ëŠ” false í™•ì¸
                    if (isLiked) {
                        $(".likeBtn").hide();
                        $(".delBtn").show();
                    } else {
                        $(".likeBtn").show();
                        $(".delBtn").hide();
                    }
                },
                error: function () {
                    console.error("ì°œ ì—¬ë¶€ í™•ì¸ AJAX ìš”ì²­ ì‹¤íŒ¨");
                }
            });


            // í˜¸í…” ì´ë¯¸ì§€ ëª©ë¡ (í˜¸í…” ì´ë¯¸ì§€ ê°œìˆ˜)
            var hotelImages = document.querySelectorAll('.hotelMain, .hotelRoom'); // ì´ë¯¸ì§€ê°€ ìˆëŠ” ëª¨ë“  ìš”ì†Œ ì„ íƒ

            // í˜¸í…” ì´ë¯¸ì§€ì™€ ê°ì‹¤ ì´ë¯¸ì§€ë¥¼ í•©ì¹œ ì „ì²´ ê°œìˆ˜ ê³„ì‚°
            var totalImages = hotelImages.length;

            // í˜¸í…” ì´ë¯¸ì§€ê°€ 5ê°œ ì´í•˜ì¼ ê²½ìš° ê°ì‹¤ ì´ë¯¸ì§€ ì¶”ê°€
            var hotelImageCount = 0;
            var roomImageCount = 0;

            // ë¨¼ì € í˜¸í…” ì´ë¯¸ì§€ë¥¼ 5ê°œê¹Œì§€ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ìˆ¨ê¹ë‹ˆë‹¤.
            hotelImages.forEach(function(image, index) {
                if (index < 5) {
                    image.style.display = 'block';  // 5ê°œê¹Œì§€ëŠ” ë³´ì´ê²Œ
                    hotelImageCount++;
                } else {
                    image.style.display = 'none';  // 6ê°œë¶€í„°ëŠ” ìˆ¨ê¹€
                }
            });

            // ê°ì‹¤ ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•´ì•¼ í•˜ëŠ” ê²½ìš°, ë¶€ì¡±í•œ ì¹¸ì„ ì±„ì›ë‹ˆë‹¤.
            var remainingSlots = 5 - hotelImageCount;

            // ê°ì‹¤ ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•  ë¶€ë¶„ ì„ íƒ (ì˜ˆ: ê°ì‹¤ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ)
            var roomImageContainer = document.querySelector('.room-images'); // ì´ ë¶€ë¶„ì„ ì ì ˆí•œ í´ë˜ìŠ¤ë‚˜ IDë¡œ ìˆ˜ì •í•˜ì„¸ìš”.

            for (var i = 0; i < remainingSlots; i++) {
                // ê°ì‹¤ ì´ë¯¸ì§€ ì¶”ê°€ ë¡œì§
                // ì˜ˆì‹œë¡œ ë¹ˆ divë¥¼ ë§Œë“¤ì–´ì„œ ì¶”ê°€í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
                var newRoomImage = document.createElement('img');
                newRoomImage.src = '/path/to/room-image-' + i + '.jpg'; // ì‹¤ì œ ì´ë¯¸ì§€ ê²½ë¡œë¡œ ë³€ê²½
                newRoomImage.className = 'hotelRoom'; // í´ë˜ìŠ¤ ì´ë¦„ ì„¤ì •
                roomImageContainer.appendChild(newRoomImage);
                roomImageCount++;
            }

            // ë§Œì•½ ê°ì‹¤ ì´ë¯¸ì§€ê°€ ë¶€ì¡±í•˜ë‹¤ë©´ ë‚¨ì€ ìë¦¬ë¥¼ ë¹ˆ ì¹¸ìœ¼ë¡œ ì±„ìš°ëŠ” ì½”ë“œ
            for (var i = roomImageCount; i < remainingSlots; i++) {
                var emptySlot = document.createElement('div');
                emptySlot.className = 'empty-slot';
                emptySlot.innerText = 'ë¹ˆ ì´ë¯¸ì§€ ì¹¸';
                roomImageContainer.appendChild(emptySlot);
            }


        }

        function page(page) {
            location.href= "/hotel/list/" + page
        }

        //ì°œ ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰ í•  í•¨ìˆ˜
        function addLike() {
            console.log("ì°œí•˜ê¸° ì‹¤í–‰");

            var hotelId = [[${hotelDTO.hotelId}]];
            var param = {
                hotelId: hotelId
            };

            $.ajax({
                url: "/like/register",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(param),
                dataType: "json",
                success: function (result, status) {
                    alert("ìŠ¤í¬ë© ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    $(".likeBtn").hide();
                    $(".delBtn").show();
                    location.reload();

                },
                error: function (result, status, error) {
                    if (result.status == 401) {
                        alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
                        location.href = "/login";
                    } else {
                        alert(result.responseText);
                        location.reload();
                    }
                }
            });
        }


        function delLike() {
            console.log("ì°œ ì‚­ì œ ì‹¤í–‰");

            var hotelId = [[${hotelDTO.hotelId}]]; // í˜¸í…” ID ê°€ì ¸ì˜¤ê¸°
            var paramData = {
                hotelId: hotelId
            };

            $.ajax({
                url: "/like/delete",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(paramData),
                success: function (result) {
                    alert("ìŠ¤í¬ë©ì´ ì·¨ì†Œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    $(".likeBtn").show();
                    $(".delBtn").hide();
                    location.reload();  // âœ… í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                },
                error: function (xhr) {
                    console.error("ì‚­ì œ ì‹¤íŒ¨:", xhr.responseText);
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + xhr.responseText);
                }
            });
        }

    </script>

</head>
<body>
<div th:replace="~{fragments/header::header}"></div>

<div layout:fragment="content">

    <div class="row mb-3" style="width: 1000px; margin: auto">
        <div class="col">
            <div class="card border-light">
                <!-- í˜¸í…” ìƒì„¸ë¶€ë¶„ -->
                <div class="row g-0 hotel-card">
                    <div>
                        <div class="hotel-images">
                            <!-- 1. í˜¸í…” ë©”ì¸ ì´ë¯¸ì§€ ì¶”ê°€ (ì²« ë²ˆì§¸ í˜¸í…” ì´ë¯¸ì§€) -->
                            <th:block th:if="${hotelDTO.hotelImgDTOList.size() > 0}">
                                <img th:src="@{'/upload/' + ${hotelDTO.hotelImgDTOList[0].imagePath}}" class="hotelMain" alt="í˜¸í…” ë©”ì¸">
                            </th:block>

                            <!-- 2. ë‚˜ë¨¸ì§€ í˜¸í…” ì´ë¯¸ì§€ ì¶”ê°€ (ë‘ ë²ˆì§¸ë¶€í„° ìµœëŒ€ 4ê°œê¹Œì§€) -->
                            <th:block th:each="img, iterStat : ${hotelDTO.hotelImgDTOList}" th:if="${iterStat.index > 0 and iterStat.index < 4}">
                                <img th:src="@{'/upload/' + ${img.imagePath}}" class="hotelRoom" alt="í˜¸í…” ì´ë¯¸ì§€">
                            </th:block>

                            <!-- 3. ê°ì‹¤ ì´ë¯¸ì§€ ì¶”ê°€ (í˜¸í…” ì´ë¯¸ì§€ê°€ ë¶€ì¡±í•  ê²½ìš°, ìµœëŒ€ 5ê°œê¹Œì§€ ê°ì‹¤ ì´ë¯¸ì§€ ì¶”ê°€) -->
                            <th:block th:each="room : ${rooms}">
                                <th:block th:each="roomImg, imgStat : ${room.roomImageDTOList}" th:if="${hotelDTO.hotelImgDTOList.size() + imgStat.index < 5}">
                                    <img th:src="@{'/upload/' + ${roomImg.imagePath}}" class="hotelRoom" alt="ê°ì‹¤ ì´ë¯¸ì§€">
                                </th:block>
                            </th:block>
                        </div>

                        <div>
                            <!--ë“±ë¡í•œ ì‚¬ì§„ì´ ì—†ì„ ë•Œ-->
                            <th:block th:unless="${hotelDTO.hotelImgDTOList.size() != 0}">
                                <div>
                                    <img src="/img/default_img.jpg" alt="noImage" style="width: 300px"/>
                                </div>
                            </th:block>
                        </div>
                    </div>
                    <div >
                        <div class="card-body">
                            <div class="mb-3">
                                &nbsp<a th:href="@{'/hotel/list?searchType=location&keyword=' + ${hotelDTO.hotelLocation}}" style="text-decoration: none"><span th:text="${hotelDTO.hotelLocation}" style="font-size: small; color: darkgray">í˜¸í…” ì§€ì—­</span></a><span th:text="' ã…£ '+${hotelDTO.companyName}" style="font-size: small; color: darkgray">ë³¸ì‚¬ëª…</span>
                                <h2 class="mt-3" th:text="${hotelDTO.hotelName}">í˜¸í…”(ì§€ì‚¬)ì´ë¦„</h2>
                            </div>



                            <div class="mb-2">

                                <i class="bi bi-geo-alt-fill"></i>

                                <span th:text="${hotelDTO.hotelAddress}">ì£¼ì†Œ</span>

                            </div>

                            <!--<span th:text="${hotelDTO.hotelInfo}">ìƒì„¸ì •ë³´</span>-->
                            <div class="text-end mb-3" style="margin-top: -50px; padding-right: -10px">
                                <div>
                                    <!-- ì§€ë„ ì—´ê¸°/ë‹«ê¸° ë²„íŠ¼ -->
                                    <button class="btn btn-outline-success" id="mapToggleBtn1" onclick="toggleMap1()" th:if="${#authentication.name != 'anonymousUser'}" style="width: 120px; margin-right: 10px">
                                        ì§€ë„ ì—´ê¸°
                                        <i class="bi bi-map"></i>
                                    </button>
                                    <!-- ì°œ ì¶”ê°€ ë²„íŠ¼ (ì²˜ìŒì—ëŠ” ë³´ì´ê²Œ ì„¤ì •) -->
                                    <button class="btn btn-outline-danger likeBtn" th:data-hotel-id="${hotelDTO.hotelId}" onclick="addLike()" style="width: 120px; display: none;">
                                        ìŠ¤í¬ë© <!--<i class="fa-regular fa-heart"></i>-->
                                        <i class="bi bi-bookmark"></i>
                                    </button>

                                    <!-- ì°œ ì‚­ì œ ë²„íŠ¼ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
                                    <button class="btn btn-danger delBtn" th:data-hotel-id="${hotelDTO.hotelId}" onclick="delLike()" style="width: 120px; display: none;">
                                        ìŠ¤í¬ë© <!--<i class="fa fa-heart" aria-hidden="true"></i>-->
                                        <i class="bi bi-bookmark-fill"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="text-end mb-3 me-3" th:if="${#authentication.name == 'anonymousUser'}" style="margin-top: -50px;">
                                <div>
                                    <!-- ì§€ë„ ì—´ê¸°/ë‹«ê¸° ë²„íŠ¼ (ë¹„íšŒì›ìš©) -->
                                    <button class="btn btn-outline-success" id="mapToggleBtn2" onclick="toggleMap2()" style="width: 120px;">
                                        ì§€ë„ ì—´ê¸°
                                        <i class="bi bi-map"></i>
                                    </button>
                                    <!-- ì°œ ì¶”ê°€ ë²„íŠ¼ (ë¹„íšŒì›ìš©) -->
                                    <button class="btn btn-outline-danger nya" style="width: 120px; display: none;" onclick="addLike()">
                                        ìŠ¤í¬ë© <!--<i class="fa-regular fa-heart"></i>-->
                                        <i class="bi bi-bookmark"></i>
                                    </button>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>

                <!-- ì§€ë„ ì˜ì—­ -->
                <div class="container" id="mapContainer" style="overflow: hidden; height: 0; transition: height 0.5s ease; margin-bottom: 10px;">
                    <div class="bg-secondary text-white d-flex justify-content-center" style="height: 500px; margin-bottom: 10px; background-color: #f0f0f0;">
                        <div class="map_wrap" style="width: 100%; height: 100%;">
                            <div id="map" style="width:100%; height:100%; position:relative; overflow:hidden;"></div>
                        </div>
                    </div>

                    <script type="text/javascript"
                            src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=0cb0450151c2b892da76c0d5dcd6535a&libraries=services"></script>

                    <script>
                        var map; // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸

                        function initMap() {
                            var mapContainer = document.getElementById('map'),
                                mapOption = {
                                    center: new kakao.maps.LatLng(33.450701, 126.570667),
                                    level: 3
                                };

                            // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                            map = new kakao.maps.Map(mapContainer, mapOption);
                        }

                        initMap(); // ì´ˆê¸° ì§€ë„ ìƒì„±

                        // ì§€ë„ íƒ€ì… ë³€ê²½ ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•œë‹¤
                        var mapTypeControl = new kakao.maps.MapTypeControl();

                        // ì§€ë„ì˜ ìƒë‹¨ ìš°ì¸¡ì— ì§€ë„ íƒ€ì… ë³€ê²½ ì»¨íŠ¸ë¡¤ì„ ì¶”ê°€í•œë‹¤
                        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

                        // ì§€ë„ì— í™•ëŒ€ ì¶•ì†Œ ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•œë‹¤
                        var zoomControl = new kakao.maps.ZoomControl();

                        // ì§€ë„ì˜ ìš°ì¸¡ì— í™•ëŒ€ ì¶•ì†Œ ì»¨íŠ¸ë¡¤ì„ ì¶”ê°€í•œë‹¤
                        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

                        // ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                        var geocoder = new kakao.maps.services.Geocoder();

                        // Thymeleafì—ì„œ í˜¸í…” ì£¼ì†Œì™€ ì´ë¦„ ê°’ì„ ê°€ì ¸ì˜´
                        var hotelAddress = "[[${hotelDTO.hotelAddress}]]";  // í˜¸í…” ì£¼ì†Œ
                        var hotelName = "[[${hotelDTO.hotelName}]]";  // í˜¸í…” ì´ë¦„

                        // ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
                        geocoder.addressSearch(hotelAddress, function(result, status) {

                            // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´
                            if (status === kakao.maps.services.Status.OK) {

                                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                                // ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œí•©ë‹ˆë‹¤
                                var marker = new kakao.maps.Marker({
                                    map: map,
                                    position: coords
                                });

                                // ì¸í¬ìœˆë„ìš°ë¡œ ì¥ì†Œì— ëŒ€í•œ ì„¤ëª…ì„ í‘œì‹œí•©ë‹ˆë‹¤
                                var infowindow = new kakao.maps.InfoWindow({
                                    content: '<div style="width:200px;text-align:center;padding:10px;font-size:14px;color:black;">' + hotelName + '</div>'  // í˜¸í…” ì´ë¦„ í‘œì‹œ
                                });
                                infowindow.open(map, marker);

                                // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
                                map.setCenter(coords);
                            }
                        });

                        // ì§€ë„ ì—´ê¸°/ë‹«ê¸° í† ê¸€ í•¨ìˆ˜
                        function toggleMap1() {
                            var mapContainer = document.getElementById("mapContainer");
                            var mapBtn1 = document.getElementById("mapToggleBtn1");

                            // í˜„ì¬ ì§€ë„ ì˜ì—­ì˜ ë†’ì´ê°€ 0ì´ë©´ í¼ì³ì§€ê³ , ì•„ë‹ˆë©´ ì ‘íˆë„ë¡ ì„¤ì •
                            if (mapContainer.style.height === "0px") {
                                mapContainer.style.height = "500px";  // í¼ì³¤ì„ ë•Œ ë†’ì´ ì„¤ì •
                                mapBtn1.innerHTML = 'ì§€ë„ ë‹«ê¸° <i class="bi bi-map-fill"></i>';
                                mapBtn1.classList.remove("btn-outline-success");
                                mapBtn1.classList.add("btn-success");
                            } else {
                                mapContainer.style.height = "0px";  // ì ‘ì—ˆì„ ë•Œ ë†’ì´ ì„¤ì •
                                mapBtn1.innerHTML = 'ì§€ë„ ì—´ê¸° <i class="bi bi-map"></i>';
                                mapBtn1.classList.remove("btn-success");
                                mapBtn1.classList.add("btn-outline-success");
                            }
                        }

                        // ì§€ë„ ì—´ê¸°/ë‹«ê¸° í† ê¸€ í•¨ìˆ˜
                        function toggleMap2() {
                            var mapContainer = document.getElementById("mapContainer");
                            var mapBtn2 = document.getElementById("mapToggleBtn2");

                            // í˜„ì¬ ì§€ë„ ì˜ì—­ì˜ ë†’ì´ê°€ 0ì´ë©´ í¼ì³ì§€ê³ , ì•„ë‹ˆë©´ ì ‘íˆë„ë¡ ì„¤ì •
                            if (mapContainer.style.height === "0px") {
                                mapContainer.style.height = "500px";  // í¼ì³¤ì„ ë•Œ ë†’ì´ ì„¤ì •
                                mapBtn2.innerHTML = 'ì§€ë„ ë‹«ê¸° <i class="bi bi-map-fill"></i>';
                                mapBtn2.classList.remove("btn-outline-primary");
                                mapBtn2.classList.add("btn-primary");
                            } else {
                                mapContainer.style.height = "0px";  // ì ‘ì—ˆì„ ë•Œ ë†’ì´ ì„¤ì •
                                mapBtn2.innerHTML = 'ì§€ë„ ì—´ê¸° <i class="bi bi-map"></i>';
                                mapBtn2.classList.remove("btn-primary");
                                mapBtn2.classList.add("btn-outline-primary");
                            }
                        }
                    </script>
                </div>

                <!-- OpenAIë¶€ë¶„ -->
                <div class="card border" style="width: 940px; margin: auto; padding-top: 17px; padding-bottom: 20px;">
                    <div style="width: 950px; margin: auto;">
                        <div style="margin-bottom: -20px">
                            <div class="form-section">
                                <h4 style="margin-left: 24px">AI ì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš” <i class="bi bi-robot"></i></h4>
                                <div class="mb-2 mt-2">
                                    <span style="margin-left: 24px;">ì´ëŸ° ì§ˆë¬¸ì€ ì–´ë– ì‹ ê°€ìš”?</span>
                                    <button class="queryButton btn btn-outline-primary btn-sm" data-query="ê´€ê´‘ì§€">ì£¼ë³€ ê´€ê´‘ì§€ë¥¼ ì•Œë ¤ì¤˜!</button>
                                    <button class="queryButton btn btn-outline-primary btn-sm" data-query="ë§›ì§‘">ì£¼ë³€ ë§›ì§‘ì„ ì•Œë ¤ì¤˜!</button>
                                </div>
                                <form id="generalQueryForm" style="display: flex; align-items: center; gap: 10px; margin-left: 24px;">
                                    <label for="generalQuery">ì§ì ‘ ì§ˆë¬¸í•´ë³´ì„¸ìš” :</label>
                                    <input type="hidden" id="hotelAddress" th:value="${hotelDTO.hotelAddress}">
                                    <input class="form-control" type="text" id="generalQuery" name="query"
                                           placeholder="ê·¼ì²˜ í¸ì˜ì‹œì„¤ì„ ì•Œë ¤ì¤˜" required
                                           style="width: 68%;">  <!-- ì…ë ¥ì¹¸ ê¸¸ì´ ì¡°ì ˆ -->
                                    <button class="btn btn-primary" type="submit">ë¬¼ì–´ë³´ê¸°</button>
                                </form><br>

                                <!-- AIì˜ ì‘ë‹µì´ ì¶œë ¥ë  ê³³ -->
                                <div id="generalResponse" style="margin-left: 24px; margin-right: 24px"></div>
                            </div>
                        </div>
                    </div>
                </div><br>

                <!-- ê°ì‹¤ ë¦¬ë·°ë¶€ë¶„ -->
                <div class="card border" style="width: 940px; margin: auto; padding-top: 17px; padding-bottom: 20px;">
                    <div style="width: 950px; margin: auto;">
                        <div style="margin-bottom: -20px">
                            <h4 style="margin-bottom: -24px; margin-left: 13px">&ensp;ê°ì‹¤ ë¦¬ë·°</h4>
                            <span>
                            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&ensp;(<span th:text="${hotelDTO.roomReviewCount}" class="roomReview">2,298</span>)&ensp;
                            <i class="bi bi-star-fill" th:classappend="'rating-' + ${#numbers.formatDecimal(hotelDTO.hotelRating, 0, 0)}"></i>
                            <span th:if="${hotelDTO.hotelRating != null and hotelDTO.hotelRating != ''}" th:text="${hotelDTO.hotelRating}+'ì '" class="hotelRating">í‰ì </span>
                            <span th:if="${hotelDTO.hotelRating == null and hotelDTO.hotelRating == ''}" class="hotelRating">ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤!</span>
                        </span>
                        </div>
                        <div style="text-align: right; margin-bottom: 15px; margin-top: -10px; margin-right: 15px; font-size: small">
                            <a th:href="@{/hotel/reviewAll(hotelId=${hotelDTO.hotelId})}" style="text-decoration: none; color: black;">
                                ì „ì²´ë³´ê¸°
                                <i class="bi bi-chevron-right"></i>
                            </a>&emsp;
                        </div>
                        <div class="row" style="width: 920px; margin: auto; padding-right: 13px">
                            <!--ë“±ë¡ëœ ë¦¬ë·°ê°€ ìˆì„ ë•Œ-->
                            <th:block th:unless="${latestReviews == null or #lists.isEmpty(latestReviews)}">
                                <div class="col-4" th:each="review : ${latestReviews}" >
                                    <div class="card border-light review-card" style="margin: -5px; padding: 15px; height: 150px; background-color: #f3f4f7">
                                        <!-- ë³„ì  í‘œì‹œ -->
                                        <p class="star-rating" th:classappend="'rating-' + ${review.rating}">
                                            <i class="bi bi-star-fill" th:if="${review.rating >= 1}" style="margin-right: -3px"></i>
                                            <i class="bi bi-star-fill" th:if="${review.rating >= 2}" style="margin-right: -3px"></i>
                                            <i class="bi bi-star-fill" th:if="${review.rating >= 3}" style="margin-right: -3px"></i>
                                            <i class="bi bi-star-fill" th:if="${review.rating >= 4}" style="margin-right: -3px"></i>
                                            <i class="bi bi-star-fill" th:if="${review.rating >= 5}" style="margin-right: -3px"></i>
                                            <i class="bi bi-star" th:if="${review.rating <= 4}" style="margin-right: -3px"></i>
                                            <i class="bi bi-star" th:if="${review.rating <= 3}" style="margin-right: -3px"></i>
                                            <i class="bi bi-star" th:if="${review.rating <= 2}" style="margin-right: -3px"></i>
                                            <i class="bi bi-star" th:if="${review.rating <= 1}" style="margin-right: -3px"></i>
                                        </p>
                                        <p th:text="${review.reviewText}">ë¦¬ë·° ë‚´ìš©</p>
                                    </div>
                                </div>
                            </th:block>
                            <!-- ë“±ë¡ ëœ ë¦¬ë·°ê°€ ì—†ì„ ê²½ìš° -->
                            <div th:if="${latestReviews == null or #lists.isEmpty(latestReviews)}" class="text-center mt-4">
                                <p class="text-muted">ë“±ë¡ ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>


            <!--ë°°ë„ˆ-->
            <div style="margin: auto">
                <div class="banner-img123-box">
                    <img src="/img/NTT_GRAND_OPENING.png" class="banner-img123" width="100%">
                </div>
            </div>


                <!-- ê°ì‹¤ ëª©ë¡ -->
                <div class="col ">
                    <div>
                        <!-- Room List Section -->
                        <section class="py-5">
                            <div class="" style="width: 950px; margin: auto; padding: 15px">
                                <h4 class="mb-3">ê°ì‹¤ ì„ íƒ</h4>

                                <th:block th:if="${rooms == null || #lists.isEmpty(rooms)}">
                                    <div style="text-align: center">
                                        <img src="/img/empty.png" alt="No likes available" width="400px">
                                        <p>ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!</p>
                                    </div>
                                </th:block>

                                <th:block th:unless="${rooms == null || #lists.isEmpty(rooms)}">
                                    <div th:each="room : ${rooms}">
                                        <div class="room"
                                             th:classappend="${!room.roomStatus} ? 'sold-out' : ''"
                                             th:data-room-id="${room.roomId}"
                                             th:data-stay-start="${room.stayStart}"
                                             th:data-stay-end="${room.stayEnd}">

                                            <div class="row g-0 border rounded overflow-hidden flex-md-row mb-4 h-md-250 position-relative card-hover">
                                                <!-- ì´ë¯¸ì§€ -->
                                                <div class="col-5 d-none d-lg-block">
                                                    <div class="image-box">
                                                        <img th:if="${!#lists.isEmpty(room.roomImageDTOList)}"
                                                             th:src="@{'/upload/' + ${room.roomImageDTOList[0].imagePath}}"
                                                             class="bd-placeholder-img rooms-img"
                                                             th:alt="${room.roomName}" height="100%">
                                                        <img th:if="${#lists.isEmpty(room.roomImageDTOList)}"
                                                             src="/img/default_img.jpg"
                                                             class="bd-placeholder-img"
                                                             alt="Default Room Image">
                                                    </div>
                                                </div>
                                                <!-- ë°© ì„¤ëª… -->
                                                <div class="col-7 p-4 d-flex flex-column position-static" style="padding-bottom: -15px">
                                                    <div class="d-flex justify-content-start gap-2 mb-1">
                                                        <span th:text="${room.roomType}" class="badge bg-dark text-white"></span>
                                                    </div>
                                                    <h3 th:text="${room.roomName}" class="mb-2">ê°ì‹¤ëª…</h3>
                                                    <p th:text="'ì˜ˆì•½ ê¸°ê°„ : ' + ${room.reservationStart} + ' ~ ' + ${room.reservationEnd}" class="card-text" style="margin-bottom: 1px"></p>
                                                    <p th:text="'ìˆ™ë°• ê¸°ê°„ : ' + ${room.stayStart} + ' ~ ' + ${room.stayEnd}" class="card-text"></p>
                                                    <div class="room-actions" style="margin-top: -5px;">
                                                        <p class="room-price mb-0"
                                                           th:text="${room.formattedRoomPrice != null ? room.formattedRoomPrice + ' ' + 'KRW' : 'ê°€ê²© ë¯¸ì •'}"></p>
                                                        <button class="btn btn-book btn-dark" style="width: 110px"
                                                                th:data-room-id="${room.roomId}"
                                                                onclick="goToRoomDetail(this)">
                                                            ìì„¸íˆë³´ê¸°
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </th:block>


                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
        <!-- ë²„íŠ¼ -->
        <div class="text-end mt-3 mb-3">
            <a class="btn btn-dark" href="/hotel/list">ëª©ë¡</a>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ëœ ìƒíƒœ -->
    <div sec:authorize="isAuthenticated()">
        <script th:inline="javascript">
            var isLoggedIn = true;
            console.log("isLoggedIn:", isLoggedIn);
        </script>
    </div>

    <!-- ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ìƒíƒœ -->
    <div sec:authorize="!isAuthenticated()">
        <script th:inline="javascript">
            var isLoggedIn = false;
            console.log("isLoggedIn:", isLoggedIn);
        </script>
    </div>

</div>


<!-- JavaScript -->
<script>
    // OpenAI ë‹µë³€ ì²˜ë¦¬
    function sendQuery(modifiedQuery) {
        $('#generalResponse').html(`<hr><br>
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-weight: bold;">
        <div class="spinner-border text-primary" role="status" style="width: 20px; height: 20px; margin-bottom: 10px;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>AIê°€ ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</span><br><br>
    </div>
    `);

        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        removeAllMarkers();

        $.ajax({
            url: '/ai/query',
            type: 'POST',
            data: { query: modifiedQuery },
            success: function(response) {
                if (response && response.results && response.results.length > 0) {
                    var resultMessage = response.results[0].output.content || "ì‘ë‹µ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
                    var formattedMessage = resultMessage
                        .replace(/\n/g, "<br>")
                        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

                    $('#generalResponse').html('<hr><br><h4>A. ë‹µë³€ :</h4><p><br>' + formattedMessage + '<br><br></p>');

                    // ì§€ë„ì— ìƒˆë¡œìš´ ì§€ì—­ì„ ì¶”ê°€
                    extractLocationsAndMarkOnMap(resultMessage);
                } else {
                    $('#generalResponse').html('<strong>ì˜¤ë¥˜:</strong> ì˜ˆìƒí•˜ì§€ ëª»í•œ ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤.');
                }
            },
            error: function(xhr, status, error) {
                $('#generalResponse').html('<strong>ì˜¤ë¥˜ ë°œìƒ:</strong> ' + error);
            }
        });
    }

    function extractLocationsAndMarkOnMap(responseText) {
        // ì •ê·œì‹ì„ ì´ìš©í•˜ì—¬ **ì§€ì—­ëª…** íŒ¨í„´ì„ ì°¾ìŒ
        var locationPattern = /\*\*(.*?)\*\*/g;
        var locations = [];
        var match;

        while ((match = locationPattern.exec(responseText)) !== null) {
            locations.push(match[1]);  // ì§€ì—­ëª…ë§Œ ì¶”ì¶œ
        }

        console.log("ì¶”ì¶œëœ ì§€ì—­ëª…:", locations); // ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê°€

        if (locations.length > 0) {
            locations.forEach(location => {
                searchLocationOnMap(location);
            });
        } else {
            console.error("ì¶”ì¶œëœ ì§€ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    var markers = []; // ë§ˆì»¤ ë°°ì—´ ì¶”ê°€

    function searchLocationOnMap(locationName) {
        var geocoder = new kakao.maps.services.Geocoder();
        var places = new kakao.maps.services.Places(); // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´

        // ğŸ”¹ 1. ì£¼ì†Œë¡œ ê²€ìƒ‰ ì‹œë„
        geocoder.addressSearch(locationName, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                addMarkerAndInfo(coords, locationName);
            } else {
                console.warn("ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨:", locationName, "í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹œë„");

                // ğŸ”¹ 2. ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ, í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹œë„
                places.keywordSearch(locationName, function(data, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        var coords = new kakao.maps.LatLng(data[0].y, data[0].x);
                        addMarkerAndInfo(coords, locationName);
                    } else {
                        console.error("í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹¤íŒ¨:", locationName);
                    }
                });
            }
        });
    }

    // ğŸ”¹ ë§ˆì»¤ & ì¸í¬ìœˆë„ìš° ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ ë¶„ë¦¬ (ì¤‘ë³µ ì œê±°)
    function addMarkerAndInfo(coords, locationName) {
        var marker = new kakao.maps.Marker({
            map: map,
            position: coords
        });

        var infowindow = new kakao.maps.InfoWindow({
            content: `<div style="width:200px;text-align:center;padding:10px;font-size:14px;color:black;">${locationName}</div>`
        });

        infowindow.open(map, marker);
        map.setCenter(coords);

        // ë§ˆì»¤ ë°°ì—´ì— ì¶”ê°€
        markers.push(marker);
    }

    // ê¸°ì¡´ì— ì¶”ê°€ëœ ëª¨ë“  ë§ˆì»¤ë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜
    function removeAllMarkers() {
        markers.forEach(function(marker) {
            marker.setMap(null);  // ì§€ë„ì—ì„œ ë§ˆì»¤ ì œê±°
        });
        markers = [];  // ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”
    }

    // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ì§ˆë¬¸ì„ ì œì¶œí•  ë•Œ
    $('#generalQueryForm').on('submit', function(event) {
        event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€

        var query = $('#generalQuery').val(); // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì§ˆë¬¸
        var hotelAddress = $('#hotelAddress').val(); // ì£¼ì†Œ ê°’
        var modifiedQuery = extractRegionFromAddress(hotelAddress) + " " + query; // ì£¼ì†Œì—ì„œ ì§€ì—­ëª…ë§Œ ì¶”ì¶œ í›„ ì§ˆë¬¸ ì¶”ê°€

        sendQuery(modifiedQuery);
    });

    // 'ê´€ê´‘ì§€', 'ë§›ì§‘' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $('.queryButton').on('click', function() {
        var hotelAddress = $('#hotelAddress').val(); // ì£¼ì†Œ ê°’
        var queryType = $(this).data('query'); // ë²„íŠ¼ì— ì„¤ì •ëœ query ê°’ (ê´€ê´‘ì§€ or ë§›ì§‘)
        var modifiedQuery = extractRegionFromAddress(hotelAddress) + " " + queryType; // ì£¼ì†Œì—ì„œ ì§€ì—­ëª…ë§Œ ì¶”ì¶œ í›„ ì„ íƒí•œ ì§ˆë¬¸ ì¶”ê°€

        sendQuery(modifiedQuery);
    });

    // ì£¼ì†Œì—ì„œ ì§€ì—­ëª…ë§Œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
    function extractRegionFromAddress(address) {
        var regionPattern = /^[^\d]+/; // ì£¼ì†Œì—ì„œ ìˆ«ìë¥¼ ì œì™¸í•œ ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì§€ì—­ëª…)
        var region = address.match(regionPattern) ? address.match(regionPattern)[0].trim() : '';
        return region;
    }

    function goToRoomDetail(button) {
        let roomId = button.getAttribute("data-room-id");
        if (roomId) {
            window.location.href = `/room/${roomId}`;
        }
    }

    function goToRoomDetail(button) {
        let roomId = button.getAttribute("data-room-id");
        if (roomId) {
            window.location.href = `/room/${roomId}`;
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        function getFormattedDateTime(offsetDays = 0) {
            let now = new Date();
            now.setDate(now.getDate() + offsetDays);
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // ì‹œê°„ëŒ€ ë³´ì •
            return now.toISOString().slice(0, 16); // "YYYY-MM-DDTHH:mm" í˜•ì‹
        }

        let checkInInput = document.getElementById("checkInDate");
        let checkOutInput = document.getElementById("checkOutDate");

        if (checkInInput) {
            checkInInput.value = getFormattedDateTime();
        }
        if (checkOutInput) {
            checkOutInput.value = getFormattedDateTime(1); // í•˜ë£¨ ë’¤ ê¸°ë³¸ê°’
        }

        checkInInput.addEventListener("change", function () {
            let checkInDate = new Date(checkInInput.value);
            let minCheckOutDate = new Date(checkInDate);
            minCheckOutDate.setDate(minCheckOutDate.getDate() + 1);
            checkOutInput.min = minCheckOutDate.toISOString().slice(0, 16);
        });
    });

</script>

</div>
<div th:replace="~{fragments/footer::footer}"></div>
</body>
</html>
