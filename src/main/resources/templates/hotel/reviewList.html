<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>NTT í˜¸í…” - í˜¸í…” í›„ê¸°</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/b17b1596b8.js" crossorigin="anonymous"></script>
    <link rel ="stylesheet" href="/assets/fonts/fontawesome-all.min.css">
    <link rel ="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel ="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">

    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© ì•„ì´ì½˜ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">

    <link rel="stylesheet" th:href="@{/css/user.css}">
    <link rel="stylesheet" th:href="@{/css/detail.css}">

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        .wrapper {
            min-height: 100vh;  /* ë·°í¬íŠ¸ ë†’ì´ë§Œí¼ ìµœì†Œ í™•ë³´ */
            display: flex;
            flex-direction: column;
        }

        .content {
            flex: 1;  /* ì»¨í…ì¸ ê°€ ëŠ˜ì–´ë‚˜ë©´ í‘¸í„°ê°€ ë°€ë¦¬ì§€ ì•Šë„ë¡ ì„¤ì • */
        }

        .footer {
            width: 100%;
            background-color: #f8f9fa;  /* í•„ìš”ì— ë”°ë¼ ë°°ê²½ìƒ‰ ì¶”ê°€ */
            padding: 10px;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <div th:replace="~{fragments/header::header}"></div>

    <div class="content">
        <div layout:fragment="content">

            <div class="row mb-3" style="width: 1000px; margin: auto">
                <div class="col">
                    <div>
                        <!-- í˜¸í…” ìƒì„¸ë¶€ë¶„ -->
                        <div class="row g-0 hotel-card" style="padding: 5px">

                            <div>
                                <section class="review-section mb-5 p-4 ">
                                    <div class="d-flex align-items-center">
                                        <a th:href="@{/hotel/read(hotelId=${hotelDTO.hotelId})}" style="text-decoration: none; color: black;">
                                            <h1>
                                                <i class="bi bi-chevron-left"></i>
                                            </h1>
                                        </a>
                                        <h2 class="mb-3 fw-bold flex-grow-1 text-center">
                                            <span th:if="${hotelDTO.roomReviewCount != null and hotelDTO.roomReviewCount != ''}"
                                                  th:text="'í˜¸í…” í›„ê¸° ('+${hotelDTO.roomReviewCount}+')'"
                                                  class="roomReviewCount">í‰ì </span>
                                        </h2>
                                    </div>

                                    <hr>
                                    <h4 class="mt-2 mb-4">í›„ê¸° í‰ì </h4>

                                    <div style="text-align: center; margin-bottom: 80px">
                                        <h1>
                                            <i class="bi bi-star-fill" th:classappend="'rating-' + ${#numbers.formatDecimal(hotelDTO.hotelRating, 0, 0)}"></i>
                                            <span th:if="${hotelDTO.hotelRating != null and hotelDTO.hotelRating != ''}" th:text="' '+${hotelDTO.hotelRating}+'ì '" class="hotelRating">í‰ì </span>
                                        </h1>
                                    </div>

                                    <hr>

                                    <!--  ë¦¬ë·° ëª©ë¡ -->
                                    <h4 class="mt-4 mb-4">í˜¸í…” ì´ìš©ê° í›„ê¸°</h4>
                                    <div id="reviewList">

                                        <div class="d-flex justify-content-center align-items-center card border-light text-muted" style="height: 60px; margin: 0 auto 10px auto; background-color: #f3f4f7;">
                                            <p class="m-0" style="vertical-align: middle;">ì´ìš©ê° í›„ê¸°ëŠ” ìµœì‹ ìˆœìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ’â€â™€ï¸ğŸ’â€â™‚ï¸</p>
                                        </div>

                                        <!-- ë¦¬ë·°ê°€ ì—†ì„ ê²½ìš° -->
                                        <div id="noReviewMessage" class="text-center mt-4" style="display: none;">
                                            <p class="text-muted">ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                        </div>

                                    </div>
                                </section>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("JavaScript ì´ˆê¸°í™”ë¨!");

            const hotelId = getHotelIdFromURL();
            console.log("DEBUG: hotelId =", hotelId);
            const memberId = document.getElementById("reviewMemberId")?.value || null;
            const reviewList = document.getElementById("reviewList");
            const loadMoreButton = document.createElement("button");

            let currentPage = 0;  // í˜„ì¬ í˜ì´ì§€
            const pageSize = 5;   // í•œ ë²ˆì— ê°€ì ¸ì˜¬ ë¦¬ë·° ê°œìˆ˜

            loadMoreButton.textContent = "More";
            loadMoreButton.classList.add("mt-3", "real-more");
            loadMoreButton.style.display = "none";  // ì´ˆê¸°ì— ìˆ¨ê¹€
            loadMoreButton.style.textAlign = "center";  // í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬
            reviewList.after(loadMoreButton);  // ë¦¬ë·° ëª©ë¡ ì•„ë˜ ë²„íŠ¼ ì¶”ê°€


            /* ë¦¬ë·° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° */
            function loadReviews() {
                fetch(`/reviews/hotel/${hotelId}?page=${currentPage}&size=${pageSize}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("DEBUG: ë¦¬ë·° API ì‘ë‹µ ë°ì´í„° =", data);

                        const reviewList = document.getElementById("reviewList");
                        const noReviewMessage = document.getElementById("noReviewMessage");

                        //  ë¦¬ë·° ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° "ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤." ë©”ì‹œì§€ë¥¼ í‘œì‹œ
                        if (!data.content || data.content.length === 0) {
                            noReviewMessage.style.display = "block";
                            loadMoreButton.style.display = "none";
                            return;
                        } else {
                            noReviewMessage.style.display = "none";
                        }

                        data.content.forEach(review => {
                            console.log("reviewId =", review.reviewId);

                            const reviewItem = document.createElement("div");
                            reviewItem.classList.add("border", "p-3", "mb-3", "rounded");
                            reviewItem.setAttribute("data-review-id", review.reviewId);
                            reviewItem.setAttribute("data-review-text", review.reviewText);
                            reviewItem.setAttribute("data-review-rating", review.rating);
                            // ë³„ì  í´ë˜ìŠ¤ ì¶”ê°€
                            let ratingClass = `rating-${review.rating}`;

                            // ë³¸ì¸ ë¦¬ë·°ì¸ ê²½ìš° ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                            let actionButtons = "";
                            if (memberId && memberId == review.memberId) {
                                actionButtons = `
                                <button class="btn btn-sm btn-outline-primary edit-review-btn"
                                        data-review-id="${review.reviewId}"
                                        data-review-text="${review.reviewText}"
                                        data-review-rating="${review.rating}">ìˆ˜ì •</button>
                                <button class="btn btn-sm btn-outline-danger delete-review-btn"
                                        data-review-id="${review.reviewId}">ì‚­ì œ</button>
                            `;
                            }

                            reviewItem.innerHTML = `
                                <div class="review-meta">
                                    <p>
                                        <span class="star-rating ${ratingClass}">${"<i class=\"bi bi-star-fill\"></i>".repeat(review.rating)}${"<i class=\"bi bi-star\"></i>".repeat(5 - review.rating)}</span>
                                    </p>
                                    <p class="text-muted small review-date">${new Date(review.reviewDate).toLocaleString()}</p>
                                </div>
                                <strong>${review.memberName || "ìµëª…"}</strong>
                                <p class="roomName">${review.roomName}</p>
                                <p>${review.reviewText}</p>
                                <div>${actionButtons}</div>
                            `;
                            reviewList.appendChild(reviewItem);
                        });

                        // í˜„ì¬ í˜ì´ì§€ ì¦ê°€
                        currentPage++;

                        // ë§ˆì§€ë§‰ í˜ì´ì§€ì¼ ê²½ìš° "ë” ë³´ê¸°" ë²„íŠ¼ ìˆ¨ê¹€
                        if (data.last) {
                            loadMoreButton.style.display = "none";
                        } else {
                            loadMoreButton.style.display = "block";
                        }

                        // ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
                        document.querySelectorAll(".edit-review-btn").forEach(button =>
                            button.addEventListener("click", openEditReviewModal)
                        );
                        document.querySelectorAll(".delete-review-btn").forEach(button =>
                            button.addEventListener("click", deleteReview)
                        );
                    })
                    .catch(error => console.error("ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
            }

            // "ë” ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            loadMoreButton.addEventListener("click", function () {
                loadReviews();
            });

            // ì´ˆê¸° ë¦¬ë·° 5ê°œ ë¶ˆëŸ¬ì˜¤ê¸°
            loadReviews();

            /* ë¦¬ë·° ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° */
            function openEditReviewModal(event) {
                const button = event.currentTarget;
                let reviewId = button.getAttribute("data-review-id");
                let reviewText = button.getAttribute("data-review-text");
                let reviewRating = button.getAttribute("data-review-rating");

                console.log(" ìˆ˜ì •í•  ë¦¬ë·° ì •ë³´:", reviewId, reviewText, reviewRating);

                document.getElementById("editReviewId").value = reviewId;
                document.getElementById("editReviewText").value = reviewText;
                document.getElementById("editRating").value = reviewRating;

                const editReviewModal = new bootstrap.Modal(document.getElementById("editReviewModal"));
                editReviewModal.show();
            }

            /* ë¦¬ë·° ì‚­ì œ ìš”ì²­ */
            function deleteReview(event) {
                const reviewId = event.currentTarget.getAttribute("data-review-id");

                if (!confirm("ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    return;
                }

                fetch(`/reviews/delete/${reviewId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
                            location.reload();
                        } else {
                            alert("ë¦¬ë·° ì‚­ì œ ì‹¤íŒ¨: " + data.message);
                        }
                    })
                    .catch(error => console.error("ë¦¬ë·° ì‚­ì œ ì˜¤ë¥˜:", error));
            }

            /* URLì—ì„œ hotelId ê°€ì ¸ì˜¤ê¸° */
            function getHotelIdFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get("hotelId"); // hotelId ê°’ ê°€ì ¸ì˜¤ê¸°
            }
        });

    </script>

    <div th:replace="~{fragments/footer::footer}" class="footer"></div>
</div>

</body>
</html>