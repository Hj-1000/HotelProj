<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Room List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/user.css}">
    <link rel="stylesheet" th:href="@{/css/roomList.css}">

</head>
<body>
<div th:replace="~{fragments/header::header}"></div>
<div layout:fragment="content">

    <!-- 예약 모달 -->
    <div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reservationModalLabel">호텔 예약하기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reservationForm">
                        <input type="hidden" id="roomId" name="roomId">
                        <div class="mb-3">
                            <label for="reservationCount" class="form-label">
                                예약 인원 <span id="recommendedCountText"></span>
                            </label>
                            <select class="form-control" id="reservationCount" name="count" required>
                                <option value="1">1명</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="checkInDate" class="form-label">체크인 날짜</label>
                            <input type="date" class="form-control" id="checkInDate" name="checkInDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="checkOutDate" class="form-label">체크아웃 날짜</label>
                            <input type="date" class="form-control" id="checkOutDate" name="checkOutDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="dayCount" class="form-label">숙박일</label>
                            <input type="text" class="form-control" id="dayCount" name="dayCount" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="totalPrice" class="form-label">총 금액</label>
                            <input type="text" class="form-control" id="totalPrice" name="totalPrice" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" id="confirmReservation" class="btn btn-primary">예약하기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 룸 배너 이미지 -->
    <section class="banner-container room-bnr">
        <img src="/img/room_banner.jpg" alt="Room Banner">
    </section>

    <!-- Room List Section -->
    <section class="py-5">
        <div class="container">
            <h2 class="text-center mb-5">Room List</h2>
            <div id="room-list" class="row">
                <div class="col-md-4" th:each="room : ${roomList}">
                    <div class="room-card"
                         th:classappend="${!room.roomStatus} ? 'sold-out' : ''"
                         th:data-room-id="${room.roomId}"
                         th:data-stay-start="${room.stayStart}"
                         th:data-stay-end="${room.stayEnd}">
                        <div class="room-image">
                            <img th:if="${!#lists.isEmpty(room.roomImageDTOList)}"
                                 th:src="@{'/upload/' + ${room.roomImageDTOList[0].imagePath}}"
                                 class="card-img-top"
                                 th:alt="${room.roomName}">
                            <img th:if="${#lists.isEmpty(room.roomImageDTOList)}"
                                 src="/img/default_img.jpg"
                                 class="card-img-top"
                                 alt="Default Room Image">

                            <!-- 예약 종료-->
                            <div class="sold-out-overlay" th:if="${!room.roomStatus}">
                                예약 종료
                            </div>

                            <div class="hover-overlay">
                                <button class="btn-view-detail" onclick="showDetailAlert()">자세히 보기</button>
                            </div>
                        </div>
                        <div class="room-text">
                            <div class="d-flex justify-content-start gap-2 mb-3">
                                <!-- 예약 가능 여부 -->
                                <span th:text="(${room.roomStatus} ? '예약 가능' : '예약 불가')"
                                      class="badge"
                                      th:classappend="${room.roomStatus} ? 'bg-success text-white' : 'bg-danger text-white'">
                                </span>
                                <span th:text="${room.roomType}" class="badge bg-dark text-white"></span>
                            </div>
                            <h5 th:text="${room.roomName}" class="card-title"></h5>
                            <p th:text="'예약 기간 : ' + ${room.reservationStart} + ' ~ ' + ${room.reservationEnd}" class="card-text"></p>
                            <p th:text="'숙박 기간 : ' + ${room.stayStart} + ' ~ ' + ${room.stayEnd}" class="card-text"></p>
                            <p th:text=" ${room.roomInfo}" class="card-text room-description"></p>
                            <div class="room-actions">
                                <p class="room-price mb-0"
                                   th:text="${room.formattedRoomPrice != null ? room.formattedRoomPrice + ' ' + '~' : '가격 미정'}"></p>
                                <button class="btn btn-book"
                                        th:text="${room.roomStatus ? '예약하기' : '예약 불가'}"
                                        th:classappend="${room.roomStatus ? 'btn-dark' : 'btn-danger text-bold'}"
                                        th:disabled="${!room.roomStatus}">
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button id="more-btn" class="btn btn-outline-primary">MORE</button>
            </div>

        </div>

        <!-- 로그인된 상태 -->
        <div sec:authorize="isAuthenticated()">
            <script th:inline="javascript">
                var isLoggedIn = true;
                console.log("isLoggedIn:", isLoggedIn);
            </script>
        </div>

        <!-- 로그인되지 않은 상태 -->
        <div sec:authorize="!isAuthenticated()">
            <script th:inline="javascript">
                var isLoggedIn = false;
                console.log("isLoggedIn:", isLoggedIn);
            </script>
        </div>

    </section>

    <!-- JavaScript -->
    <script>

        /* 나중에 삭제하기 */
        function showDetailAlert() {
            alert("아직 준비중인 서비스입니다.");
        }

        let reservationModal;

        document.addEventListener("DOMContentLoaded", function () {
            reservationModal = new bootstrap.Modal(document.getElementById('reservationModal')); // 모달 초기화
            addReservationButtonEvent(); // 예약 버튼 이벤트 추가
            updateRoomReservationStatus(); // 방 예약 상태 업데이트

            // 체크인 & 체크아웃 날짜 변경 시 숙박일과 총 비용 계산
            const checkInInput = document.getElementById("checkInDate");
            const checkOutInput = document.getElementById("checkOutDate");

            checkInInput.addEventListener("change", updateCheckOutMinDate);
            checkOutInput.addEventListener("change", calculateStayAndPrice);
        });

        /* 비로그인 , 로그인 예외처리 */
        function addReservationButtonEvent(parentElement = document) {
            parentElement.querySelectorAll('.btn-book').forEach(button => {
                if (!button.hasAttribute("data-event-added")) { // 중복 방지
                    button.setAttribute("data-event-added", "true");

                    button.addEventListener("click", function (e) {
                        if (!isLoggedIn) {
                            alert("로그인이 필요합니다.");
                            window.location.href = "/login";
                            return;
                        }

                        const roomCard = button.closest(".room-card");
                        if (!roomCard) {
                            console.error(" Error: Room card element not found.");
                            return;
                        }

                        const roomId = roomCard.dataset.roomId;
                        if (!roomId) {
                            console.error("Error: Room ID not found.");
                            return;
                        }

                        const roomPriceElement = roomCard.querySelector(".room-price");
                        if (!roomPriceElement) {
                            console.error(" Error: Room price element not found.");
                            return;
                        }

                        const roomPrice = roomPriceElement.innerText;
                        const stayStart = roomCard.dataset.stayStart;
                        const stayEnd = roomCard.dataset.stayEnd;

                        //  디버깅 추가
                        console.log(" 예약 버튼 클릭됨");
                        console.log("Room ID:", roomId);
                        console.log("Room Price:", roomPrice);
                        console.log("체크인 가능 날짜:", stayStart);
                        console.log("체크아웃 가능 날짜:", stayEnd);

                        document.getElementById("roomId").value = roomId;
                        document.getElementById("totalPrice").value = roomPrice;

                        const checkInInput = document.getElementById("checkInDate");
                        const checkOutInput = document.getElementById("checkOutDate");
                        const reservationCount = document.getElementById("reservationCount");
                        const recommendedText = document.getElementById("recommendedCountText");

                        checkInInput.min = stayStart;
                        checkInInput.max = stayEnd;
                        checkOutInput.min = stayStart;
                        checkOutInput.max = stayEnd;

                        checkInInput.removeEventListener("change", updateCheckOutMinDate); // 기존 이벤트 제거 후 다시 추가
                        checkInInput.addEventListener("change", updateCheckOutMinDate);

                        const roomType = roomCard.querySelector(".badge.bg-dark").innerText.trim();

                        // 객실 유형별 최대 인원 및 추천 인원 표시
                        let maxPeople = getMaxPeopleByRoomType(roomType);
                        let recommendedTextValue = getRecommendedTextByRoomType(roomType);

                        // 기존 옵션 제거
                        reservationCount.innerHTML = "";

                        // 새로운 옵션 추가
                        for (let i = 1; i <= maxPeople; i++) {
                            let option = document.createElement("option");
                            option.value = i;
                            option.text = `${i}명`;
                            reservationCount.appendChild(option);
                        }

                        // 추천 인원 텍스트 업데이트
                        recommendedText.innerText = recommendedTextValue;

                        //  모달이 제대로 열리는지 확인
                        console.log(" 예약 모달 열기");
                        reservationModal.show();
                    });
                }
            });
        }

        function getMaxPeopleByRoomType(roomType) {
            const roomCapacity = {
                "Single": 1,
                "Double": 2,
                "Suite": 4,
                "Deluxe": 5,
                "Family": 6
            };
            return roomCapacity[roomType] || 1;
        }

        function getRecommendedTextByRoomType(roomType) {
            const recommendedTextMap = {
                "Single": "(추천 인원 : 1명)",
                "Double": "(추천 인원 : 1~2명)",
                "Suite": "(추천 인원 : 2~4명)",
                "Deluxe": "(추천 인원 : 4~5명)",
                "Family": "(추천 인원 : 4~6명)"
            };
            return recommendedTextMap[roomType] || "";
        }

        // 체크인 날짜 변경 시 체크아웃 최소 날짜 설정 함수 추가
        function updateCheckOutMinDate() {
            const checkInInput = document.getElementById("checkInDate");
            const checkOutInput = document.getElementById("checkOutDate");

            let checkInDate = new Date(checkInInput.value);
            if (!isNaN(checkInDate.getTime())) {
                let nextDay = new Date(checkInDate);
                nextDay.setDate(nextDay.getDate() + 1);
                checkOutInput.min = nextDay.toISOString().split("T")[0];
            }

            calculateStayAndPrice(); // 추가: 숙박일 및 총 비용 계산
        }

        /* 체크인 & 체크아웃 날짜 변경 시 자동으로 숙박일과 총 금액 계산*/

        function calculateStayAndPrice() {
            const checkInInput = document.getElementById("checkInDate");
            const checkOutInput = document.getElementById("checkOutDate");
            const totalPriceInput = document.getElementById("totalPrice");
            const dayCountInput = document.getElementById("dayCount");

            const checkInDate = new Date(checkInInput.value);
            const checkOutDate = new Date(checkOutInput.value);

            if (!isNaN(checkInDate.getTime()) && !isNaN(checkOutDate.getTime()) && checkOutDate > checkInDate) {
                // 총 숙박 일수 계산
                const stayDays = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));

                // 몇 박 몇 일 계산
                const nights = stayDays;  // 박 수
                const days = stayDays + 1;  // 실제 숙박일은 박 + 1일

                // 몇 박 몇 일 형식으로 출력
                dayCountInput.value = `${nights}박 ${days}일`;

                // 객실 가격 가져오기
                const roomPriceElement = document.querySelector(".room-card[data-room-id='" + document.getElementById("roomId").value + "'] .room-price");

                if (roomPriceElement) {
                    const roomPriceText = roomPriceElement.innerText.replace(/[^\d]/g, ""); // 숫자만 추출
                    const roomPrice = parseInt(roomPriceText, 10);

                    if (!isNaN(roomPrice)) {
                        const totalPrice = roomPrice * nights; // 1박 기준 가격 * 박 수
                        totalPriceInput.value = totalPrice.toLocaleString() + " KRW";
                    } else {
                        totalPriceInput.value = "가격 오류";
                    }
                } else {
                    totalPriceInput.value = "객실 가격 정보 없음";
                }
            } else {
                dayCountInput.value = "";
                totalPriceInput.value = "";
            }
        }


        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("confirmReservation").addEventListener("click", function () {
                let roomId = document.getElementById("roomId").value;
                let checkInDate = document.getElementById("checkInDate").value;
                let checkOutDate = document.getElementById("checkOutDate").value;
                let count = document.getElementById("reservationCount").value;

                //  디버깅 추가
                console.log("예약하기 버튼 클릭됨");
                console.log("Room ID:", roomId);
                console.log("체크인 날짜:", checkInDate);
                console.log("체크아웃 날짜:", checkOutDate);

                if (!roomId || !checkInDate || !checkOutDate) {
                    alert(" 예약 정보를 모두 입력해주세요.");
                    return;
                }

                fetch("/reservation/register", {  // 새로운 엔드포인트
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        roomId: roomId,
                        checkInDate: checkInDate,
                        checkOutDate: checkOutDate,
                        count: count
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("예약이 완료되었습니다!");
                            location.reload();
                        } else {
                            alert("예약 실패: " + data.message);
                        }
                    })
                    .catch(error => console.error("예약 요청 중 오류 발생:", error));
            });
        });

        // 예약 상태 업데이트 함수
        function updateRoomReservationStatus(parentElement = document) {
            const today = new Date();

            parentElement.querySelectorAll('.room-card').forEach(roomCard => {
                const stayEnd = roomCard.dataset.stayEnd;

                // stayEnd 값이 유효한지 확인
                if (!stayEnd) {
                    console.warn(`Invalid stayEnd for roomCard:`, roomCard);
                    return;
                }

                const reservationEndDate = new Date(stayEnd);

                // 예약기간이 지난 경우에만 표시
                if (reservationEndDate < today) {
                    const overlay = roomCard.querySelector('.sold-out-overlay');
                    if (overlay) {
                        overlay.style.display = 'flex';
                    }

                    // 예약 불가 버튼 처리
                    const button = roomCard.querySelector('.btn-book');
                    button.textContent = '예약 불가';
                    button.disabled = true;
                    button.classList.remove('btn-dark');
                    button.classList.add('btn-danger', 'text-bold');
                }
            });
        }

        // 모달 닫힐 때 강제 초기화
        document.getElementById('reservationModal').addEventListener('hidden.bs.modal', function () {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        });

        // 'More' 버튼과 현재 페이지 변수
        const moreButton = document.getElementById('more-btn');
        let currentPage = 0;

        // 'More' 버튼 클릭 이벤트 리스너 추가
        moreButton.addEventListener('click', function () {
            currentPage++;
            // 서버로 AJAX 요청
            fetch(`/roomList/data?page=${currentPage}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Fetched data:', data); // 받아온 데이터를 확인

                    const roomList = document.getElementById('room-list');

                    data.rooms.forEach(room => {
                        if (document.querySelector(`.room-card[data-room-id="${room.roomId}"]`)) {
                            console.warn(`Room with ID ${room.roomId} is already added. Skipping.`);
                            return;
                        }

                        const roomCard = `
                <div class="col-md-4">
                    <div class="room-card" data-room-id="${room.roomId}" data-stay-start="${room.stayStart}" data-stay-end="${room.stayEnd}">
                        <div class="room-image">
                            <img src="${room.roomImageDTOList.length > 0 ? '/upload/' + room.roomImageDTOList[0].imagePath : '/img/default_img.jpg'}" class="card-img-top" alt="Room Image">
                            <div class="sold-out-overlay" style="display: ${room.roomStatus ? 'none' : 'flex'}">
                                예약 종료
                            </div>
                        </div>
                        <div class="room-text">
                            <div class="d-flex justify-content-start gap-2 mb-3">
                                <span class="badge ${room.roomStatus ? 'bg-success text-white' : 'bg-danger text-white'}">
                                    ${room.roomStatus ? '예약 가능' : '예약 불가'}
                                </span>
                                <span class="badge bg-dark text-white">${room.roomType}</span>
                            </div>
                            <h5 class="card-title">${room.roomName}</h5>
                            <p class="card-text">예약 기간 : ${room.reservationStart} ~ ${room.reservationEnd}</p>
                            <p class="card-text">숙박 기간 : ${room.stayStart} ~ ${room.stayEnd}</p>
                            <div class="room-actions">
                                <p class="room-price mb-0">${room.formattedRoomPrice ? room.formattedRoomPrice +  ' ' + '~' : '가격 미정'}</p>
                                <button class="btn btn-book ${room.roomStatus ? 'btn-dark' : 'btn-danger'}" ${!room.roomStatus ? 'disabled' : ''}>
                                    ${room.roomStatus ? '예약하기' : '예약 불가'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
                        roomList.insertAdjacentHTML('beforeend', roomCard);
                    });

                    if (data.isLastPage) {
                        moreButton.style.display = 'none';
                    }

                    addReservationButtonEvent(roomList);
                })
                .catch(error => {
                    console.error('Error fetching more rooms:', error);
                    moreButton.textContent = 'Error';
                    moreButton.disabled = true;
                });
        });

    </script>
</div>
<div th:replace="~{fragments/footer::footer}"></div>
</body>
</html>
