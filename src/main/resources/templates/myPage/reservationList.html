<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>NTT호텔</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" th:href="@{/css/user.css}">
  <link rel="stylesheet" th:href="@{/css/reservationList.css}">
</head>
<body>
<div th:replace="~{fragments/header::header}"></div>
<ul class="nav nav-tabs mb-4 d-flex justify-content-center">
  <li class="nav-item">
    <a class="nav-link nav-link1" href="/myPage/update">회원정보 수정</a>
  </li>
  <li class="nav-item">
    <a class="nav-link nav-link1 active" href="/myPage/reservationList">호텔 예약내역</a>
  </li>
  <li class="nav-item">
    <a class="nav-link nav-link1" href="/myPage/roomService">룸서비스 신청</a>
  </li>
</ul>

<!--본문-->
<div layout:fragment="content" class="mypage-container">
  <div class="container">
    <h2 class="text-center mb-4">호텔 예약/결제내역</h2>

    <!-- 예약이 없을 경우 메시지 표시 -->
    <div th:if="${reservations == null or #lists.isEmpty(reservations)}" class="alert alert-warning text-center">
      현재 예약 내역이 없습니다.
    </div>

    <!-- 예약 내역이 있을 경우 -->
    <div th:if="${reservations != null and not #lists.isEmpty(reservations)}">
      <!-- 예약 내역 테이블 -->
      <table class="table table-hover">
        <thead class="table-dark">
        <tr>
          <th>이미지</th>
          <th>호텔/객실정보</th>
          <th>체크인/체크아웃</th>
          <th>예약 상태</th>
          <th>예약 관리</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="reservation, iterStat : ${reservations}">
          <td class="align-middle text-center">
            <img th:src="@{'/upload/' + ${reservation.room.roomImageDTOList[0].imagePath}}"
                 alt="Room Image" class="room-image">
            <span th:if="${reservation.room.roomImageDTOList == null or #lists.isEmpty(reservation.room.roomImageDTOList)}">이미지 없음</span>
          </td>
          <td th:text="${reservation.room.roomName}"></td>
          <td>
            <span th:text="${reservation.checkInDate}"></span> ~
            <span th:text="${reservation.checkOutDate}"></span>
          </td>
          <td>
            <span th:if="${reservation.reservationStatus == '취소 요청'}" class="badge bg-warning text-dark">취소 요청중</span>
            <span th:if="${reservation.reservationStatus == '예약 완료'}" class="badge bg-success">예약 완료</span>
            <span th:if="${reservation.reservationStatus == '취소 완료'}" class="badge bg-danger">취소 완료</span>
          </td>
          <td>
            <!-- 예약 취소 버튼 (취소 요청 시 비활성화) -->
            <button type="button"
                    class="btn btn-danger btn-sm cancel-btn"
                    th:data-reservation-id="${reservation.reservationId}"
                    th:disabled="${reservation.reservationStatus == '취소 요청' or reservation.reservationStatus == '취소 완료'}"
                    th:classappend="${reservation.reservationStatus == '취소 요청' or reservation.reservationStatus == '취소 완료'} ? 'btn-disabled'">
              예약 취소
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    <!-- 페이지네이션 -->
    <div class="d-flex justify-content-center mt-4" th:if="${reservations != null and not #lists.isEmpty(reservations)}">
      <ul class="pagination">
        <!-- 처음 페이지 -->
        <li class="page-item" th:if="${currentPage > 0}">
          <a class="page-link" th:href="@{/myPage/reservationList(page=0)}">처음</a>
        </li>

        <!-- 이전 페이지 -->
        <li class="page-item" th:if="${currentPage > 0}">
          <a class="page-link" th:href="@{/myPage/reservationList(page=${currentPage - 1})}">이전</a>
        </li>

        <!-- 페이지 번호 -->
        <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
          <li class="page-item" th:classappend="${currentPage == i} ? 'active'">
            <a class="page-link" th:href="@{/myPage/reservationList(page=${i})}" th:text="${i + 1}"></a>
          </li>
        </th:block>

        <!-- 다음 페이지 -->
        <li class="page-item" th:if="${currentPage + 1 < totalPages}">
          <a class="page-link" th:href="@{/myPage/reservationList(page=${currentPage + 1})}">다음</a>
        </li>

        <!-- 마지막 페이지 -->
        <li class="page-item" th:if="${currentPage + 1 < totalPages}">
          <a class="page-link" th:href="@{/myPage/reservationList(page=${totalPages - 1})}">마지막</a>
        </li>
      </ul>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".cancel-btn").forEach(button => {
        button.addEventListener("click", function () {
          const reservationId = this.getAttribute("data-reservation-id");

          if (!confirm("정말 예약을 취소하시겠습니까?")) {
            return; // 취소 시 아무 작업도 안 함
          }

          fetch("/myPage/reservation/cancel", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "reservationId=" + encodeURIComponent(reservationId)
          })
                  .then(response => response.text())
                  .then(data => {
                    alert(data); // 서버 응답 메시지 표시

                    // 현재 페이지 번호를 유지하며 새로고침
                    const currentPage = new URLSearchParams(window.location.search).get("page") || 0;
                    window.location.href = "/myPage/reservationList?page=" + currentPage;
                  })
                  .catch(error => {
                    console.error("예약 취소 오류:", error);
                    alert("예약 취소 중 오류가 발생했습니다.");
                  });
        });
      });
    });
  </script>
</div>
<div th:replace="~{fragments/footer::footer}"></div>
</body>
</html>