<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>NTT호텔</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" th:href="@{/css/user.css}">
  <link rel="stylesheet" th:href="@{/css/reservationList.css}">
  <style>
    /* 마이페이지 화면 스타일 */
    .mypage-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: calc(100vh - 209px); /* 100vh = 화면 전체 높이를 차지하도록 (-209px 는 헤더와 푸터의 높이) */
    }

    .mypage-card {
      width: 100%;
      max-width: 800px; /* 카드 너비 */
      padding: 20px 215px 20px 215px;
      border: none;
    }

    /* 기본 탭의 글씨 색을 회색으로 설정 */
    .nav-item .nav-link1 {
      width: 270px; /* 원하는 너비로 수정 */
      text-align: center; /* 텍스트 중앙 정렬 */
      padding: 10px 20px; /* 패딩을 추가하여 버튼이 더 커지도록 설정 */
    }

    /* active 상태일 때 배경을 회색으로 변경 */
    .nav-link1.active {
      background-color: #6c757d !important; /* 회색 배경 */
      color: white !important; /* 흰색 글씨 */
    }

    /* 호버 시 배경과 글씨 색을 변경 */
    .nav-link1:hover {
      background-color: #5a6268 !important; /* 호버 시 어두운 회색 배경 */
      color: white !important; /* 호버 시 흰색 글씨 */
    }

    /* 예약 취소 버튼 비활성화 스타일 */
    .btn-disabled {
      background-color: #ccc !important;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div th:replace="~{fragments/header::header}"></div>
<br>
<ul class="nav nav-tabs mb-4 d-flex justify-content-center">
  <li class="nav-item">
    <a class="nav-link nav-link1" href="/myPage/update">회원정보 수정</a>
  </li>
  <li class="nav-item">
    <a class="nav-link nav-link1 active" href="/myPage/reservationList">호텔 예약내역</a>
  </li>
  <li class="nav-item">
    <a class="nav-link nav-link1" href="/myPage/roomService">룸서비스 신청</a>
  </li>
</ul>

<!--본문-->
<div layout:fragment="content" class="mypage-container">
  <div class="container mt-5">
    <h2 class="text-center mb-4">호텔 예약/결제내역</h2>

    <!-- 예약이 없을 경우 메시지 표시 -->
    <div th:if="${reservations == null or #lists.isEmpty(reservations)}" class="alert alert-warning text-center">
      현재 예약 내역이 없습니다.
    </div>

    <div th:if="${reservations != null and not #lists.isEmpty(reservations)}">
      <p th:text="'예약 개수: ' + ${#lists.size(reservations)}"></p>
    </div>

    <!-- 예약 내역이 있을 경우 -->
    <div th:if="${reservations != null and not #lists.isEmpty(reservations)}">
      <!-- 예약 내역 테이블 -->
      <table class="table table-hover">
        <thead class="table-dark">
        <tr>
          <th>No</th>
          <th>호텔/객실정보</th>
          <th>체크인/체크아웃</th>
          <th>예약 상태</th>
          <th>예약 관리</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="reservation, iterStat : ${reservations}">
          <td th:text="${iterStat.count}"></td>
          <td th:text="${reservation.room.roomName}"></td>
          <td>
            <span th:text="${reservation.checkInDate}"></span> ~
            <span th:text="${reservation.checkOutDate}"></span>
          </td>
          <td>
            <span th:if="${reservation.reservationStatus == '취소 요청'}" class="badge bg-warning text-dark">취소 요청중</span>
            <span th:if="${reservation.reservationStatus == '예약 완료'}" class="badge bg-success">예약 완료</span>
            <span th:if="${reservation.reservationStatus == '취소 완료'}" class="badge bg-danger">취소 완료</span>
          </td>
          <td>
            <!-- 예약 취소 버튼 (취소 요청 시 비활성화) -->
            <button type="button"
                    class="btn btn-danger btn-sm cancel-btn"
                    th:data-reservation-id="${reservation.reservationId}"
                    th:disabled="${reservation.reservationStatus == '취소 요청' or reservation.reservationStatus == '취소 완료'}"
                    th:classappend="${reservation.reservationStatus == '취소 요청' or reservation.reservationStatus == '취소 완료'} ? 'btn-disabled'">
              예약 취소
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".cancel-btn").forEach(button => {
        button.addEventListener("click", function () {
          const reservationId = this.getAttribute("data-reservation-id");

          if (!confirm("정말 예약을 취소하시겠습니까?")) {
            return; // 취소 시 아무 작업도 안 함
          }

          fetch("/myPage/reservation/cancel", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "reservationId=" + encodeURIComponent(reservationId)
          })
                  .then(response => response.text())
                  .then(data => {
                    alert(data); // 서버 응답 메시지 표시
                    location.reload(); // 페이지 새로고침
                  })
                  .catch(error => {
                    console.error("예약 취소 오류:", error);
                    alert("예약 취소 중 오류가 발생했습니다.");
                  });
        });
      });
    });
  </script>
</div>
<div th:replace="~{fragments/footer::footer}"></div>
</body>
</html>