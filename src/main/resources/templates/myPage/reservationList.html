<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>NTTí˜¸í…”</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" th:href="@{/css/user.css}">
  <link rel="stylesheet" th:href="@{/css/reservationList.css}">
</head>
<body>
<div th:replace="~{fragments/header::header}"></div>
<ul class="nav nav-tabs d-flex justify-content-center">
  <li class="nav-item">
    <a class="nav-link nav-link1" href="/myPage/update">íšŒì›ì •ë³´ ìˆ˜ì •</a>
  </li>
  <li class="nav-item">
    <a class="nav-link nav-link1 active" href="/myPage/reservationList">í˜¸í…” ì˜ˆì•½ë‚´ì—­</a>
  </li>
  <li class="nav-item">
    <a class="nav-link nav-link1" href="/myPage/order/history">ë£¸ì„œë¹„ìŠ¤ ì£¼ë¬¸ë‚´ì—­</a>
  </li>
</ul>

<!--ë³¸ë¬¸-->
<div layout:fragment="content" class="mypage-container">
  <div class="container">
    <h2 class="text-center mb-4">í˜¸í…” ì˜ˆì•½/ê²°ì œë‚´ì—­</h2>

    <!-- ì˜ˆì•½ì´ ì—†ì„ ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ -->
    <div th:if="${reservations == null or #lists.isEmpty(reservations)}" class="alert alert-warning text-center">
      í˜„ì¬ ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
    </div>

    <!-- ì˜ˆì•½ ë‚´ì—­ì´ ìˆì„ ê²½ìš° -->
    <div th:if="${reservations != null and not #lists.isEmpty(reservations)}">
      <!-- ì˜ˆì•½ ë‚´ì—­ í…Œì´ë¸” -->
      <table class="table table-hover">
        <thead class="table-dark">
        <tr>
          <th>ê°ì‹¤ ì´ë¯¸ì§€</th>
          <th>í˜¸í…”/ê°ì‹¤ì •ë³´</th>
          <th>ê°ì‹¤ íƒ€ì…</th>
          <th>ì´ ì¸ì›</th>
          <th>ì²´í¬ì¸/ì²´í¬ì•„ì›ƒ</th>
          <th>ê²°ì œ ê¸ˆì•¡</th>
          <th>ì˜ˆì•½ ìƒíƒœ</th>
          <th>ì˜ˆì•½ ê´€ë¦¬</th>
          <th>ë£¸ ì„œë¹„ìŠ¤</th>
          <th>ê²°ì œ</th>
          <th>ê²°ì œì™„ë£Œê¸ˆì•¡</th>
          <th>ê²°ì œí•„ìš”ê¸ˆì•¡</th>
          <th>ì‚­ì œ</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="reservation, iterStat : ${reservations}"
            th:data-reservation-id="${reservation.reservationId}"
            th:data-room-id="${reservation.room.roomId}">
          <td class="align-middle text-center">
            <img th:src="@{'/upload/' + ${reservation.room.roomImageDTOList[0].imagePath}}"
                 alt="Room Image" class="room-image">
            <span th:if="${reservation.room.roomImageDTOList == null or #lists.isEmpty(reservation.room.roomImageDTOList)}">ì´ë¯¸ì§€ ì—†ìŒ</span>
          </td>
          <td class="roomName" th:text="${reservation.room.roomName}"></td>
          <td th:text="${reservation.room.roomType}"></td>
          <td th:text="${reservation.count} + 'ëª…'"></td>
          <td>
            <span th:text="${#temporals.format(reservation.checkInDate, 'yyyy-MM-dd HH:mm')}"></span> ~
            <span th:text="${#temporals.format(reservation.checkOutDate, 'yyyy-MM-dd HH:mm')}"></span>
            <span class="payBy" th:text="${reservation.memberId}" hidden="hidden"></span>
          </td>
          <td>
            <span id="roomPrice" th:if="${reservation.totalPrice != null}" th:text="'â‚©' + ${#numbers.formatInteger(reservation.totalPrice, 1, 'COMMA')}"></span>
            <span th:unless="${reservation.totalPrice != null}">-</span>
            <!-- ë£¸ì„œë¹„ìŠ¤ ê¸ˆì•¡ í‘œì‹œ -->
            <div th:if="${reservation.totalServiceOrderPrice != null and reservation.totalServiceOrderPrice > 0}"
                 class="text-primary mt-2">
              <small>ë£¸ì„œë¹„ìŠ¤ ê¸ˆì•¡: <span class="roomServicePrice" th:text="'â‚©' +${#numbers.formatInteger(reservation.totalServiceOrderPrice, 1, 'COMMA')}"></span></small>
            </div>
          </td>
          <td>
              <span th:switch="${reservation.reservationStatus}">
                  <span th:case="'ì˜ˆì•½'" class="badge bg-success">ì˜ˆì•½ ì™„ë£Œ</span>
                  <span th:case="'ì·¨ì†Œ ìš”ì²­'" class="badge bg-warning text-dark">ì·¨ì†Œ ìš”ì²­ì¤‘</span>
                  <span th:case="'ì·¨ì†Œ ì™„ë£Œ'" class="badge bg-danger">
                      ì·¨ì†Œ ì™„ë£Œ
                  </span>
                  <span th:case="*" class="badge bg-secondary">ì•Œ ìˆ˜ ì—†ìŒ</span>
              </span>
          </td>
          <td>
            <!-- ì˜ˆì•½ ì·¨ì†Œ ë²„íŠ¼ (ì·¨ì†Œ ìš”ì²­ ì‹œ ë¹„í™œì„±í™”) -->
            <button type="button"
                    class="btn btn-danger btn-sm cancel-btn"
                    th:data-reservation-id="${reservation.reservationId}"
                    th:disabled="${reservation.reservationStatus == 'ì·¨ì†Œ ìš”ì²­' or reservation.reservationStatus == 'ì·¨ì†Œ ì™„ë£Œ'}"
                    th:classappend="${reservation.reservationStatus == 'ì·¨ì†Œ ìš”ì²­' or reservation.reservationStatus == 'ì·¨ì†Œ ì™„ë£Œ'} ? 'btn-disabled'">
              ì˜ˆì•½ ì·¨ì†Œ
            </button>
          </td>
          <td>
            <button type="button"
                    class="btn btn-primary btn-sm"
                    th:data-reservation-id="${reservation.reservationId}"
                    th:data-room-id="${reservation.room.roomId}"
                    th:disabled="${reservation.reservationStatus != 'ì˜ˆì•½'}"
                    th:onclick="|window.location.href='/myPage/menu/list?reservationId=' + ${reservation.reservationId} + '&roomId=' + ${reservation.room.roomId}|">
              ì‹ ì²­
            </button>
          </td>
          <td>
            <button type="button"
                    class="btn btn-primary btn-sm"
                    th:disabled="${reservation.reservationStatus != 'ì˜ˆì•½'}"
                    onclick="requestPay(event)">ê²°ì œ</button>
          </td>
          <td class="paymenttest1" th:text="${reservation.paymentTotalPrice}"></td>
          <td class="paymenttest2" th:text="${reservation.totalPrice + reservation.totalServiceOrderPrice - reservation.paymentTotalPrice}"></td>
          <!-- ì‚­ì œ ì•„ì´ì½˜ -->
          <td class="text-center">
            <i class="bi bi-trash-fill delete-icon"
               role="button"
               th:data-reservation-id="${reservation.reservationId}"
               th:if="${reservation.reservationStatus == 'ì·¨ì†Œ ì™„ë£Œ'}"
               style="font-size: 1.5rem; cursor: pointer;"></i>

            <div th:if="${reservation.reservationStatus == 'ì·¨ì†Œ ì™„ë£Œ' and reservation.timeRemaining > 0}"
                 th:data-time-remaining="${reservation.timeRemaining}"
                 class="countdown-timer text-danger small mt-1">
              <span>00:00</span>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="d-flex justify-content-center mt-4" th:if="${reservations != null and not #lists.isEmpty(reservations)}">
      <ul class="pagination">
        <!-- ì²˜ìŒ í˜ì´ì§€ -->
        <li class="page-item" th:if="${currentPage > 0}">
          <a class="page-link" th:href="@{/myPage/reservationList(page=0)}">ì²˜ìŒ</a>
        </li>

        <!-- ì´ì „ í˜ì´ì§€ -->
        <li class="page-item" th:if="${currentPage > 0}">
          <a class="page-link" th:href="@{/myPage/reservationList(page=${currentPage - 1})}">ì´ì „</a>
        </li>

        <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
        <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
          <li class="page-item" th:classappend="${currentPage == i} ? 'active'">
            <a class="page-link" th:href="@{/myPage/reservationList(page=${i})}" th:text="${i + 1}"></a>
          </li>
        </th:block>

        <!-- ë‹¤ìŒ í˜ì´ì§€ -->
        <li class="page-item" th:if="${currentPage + 1 < totalPages}">
          <a class="page-link" th:href="@{/myPage/reservationList(page=${currentPage + 1})}">ë‹¤ìŒ</a>
        </li>

        <!-- ë§ˆì§€ë§‰ í˜ì´ì§€ -->
        <li class="page-item" th:if="${currentPage + 1 < totalPages}">
          <a class="page-link" th:href="@{/myPage/reservationList(page=${totalPages - 1})}">ë§ˆì§€ë§‰</a>
        </li>
      </ul>
    </div>
  </div>

  <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
  <script th:inline="javascript">
    function requestPay(event) {
      IMP.init("imp67611643");

      var row = event.target.closest("tr");

      var roomName = row.querySelector(".roomName")?.textContent?.trim() || "í˜¸í…” ê°ì‹¤";
      var roomPrice = row.querySelector("#roomPrice")?.textContent?.replace("â‚©", "").replace(",", "").trim() || "0";
      var roomServicePriceElement = row.querySelector(".roomServicePrice");
      var roomServicePrice = roomServicePriceElement ? roomServicePriceElement.textContent.replace("â‚©", "").replace(",", "").trim() : "0";
      var reservationId = row.getAttribute("data-reservation-id");
      var roomId = row.getAttribute("data-room-id");

      var paidPrice = parseInt(row.querySelector(".paymenttest1")?.textContent.replace("â‚©", "").replace(",", "").trim()) || 0;

      roomPrice = parseInt(roomPrice) || 0;
      roomServicePrice = parseInt(roomServicePrice) || 0;

      let paymentPrice = roomPrice + roomServicePrice - paidPrice;

      if (paymentPrice <= 0) {
        alert("ê²°ì œí•  ê¸ˆì•¡ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      var merchantUid = "order_" + new Date().getTime();

      IMP.request_pay({
        pg: "html5_inicis",
        pay_method: "card",
        merchant_uid: merchantUid,
        name: roomName,
        amount: paymentPrice,
        buyer_name: row.querySelector(".payBy")?.textContent?.trim() || "êµ¬ë§¤ì",
      }, function (rsp) {
        if (rsp.success) {
          alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");

          // ê²°ì œ ì •ë³´ ì„œë²„ì— ì „ì†¡
          var paymentDTO = {
            roomPrice: roomPrice,
            roomServicePrice: roomServicePrice,
            totalPrice: paymentPrice,
            memberId: row.querySelector(".payBy")?.textContent?.trim() || "êµ¬ë§¤ì", // ì˜ˆì•½í•œ ë©¤ë²„ì˜ ID
            reservationId: reservationId,
            roomId: roomId
          };

          fetch("/payment", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(paymentDTO),
          })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      location.reload();
                    } else {
                      alert("ì„œë²„ì— ê²°ì œ ì •ë³´ ì €ì¥ ì‹¤íŒ¨");
                    }
                  })
                  .catch(error => {
                    console.error("ê²°ì œ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    alert("ê²°ì œ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                  });

        } else {
          alert("ê²°ì œ ì‹¤íŒ¨: " + rsp.error_msg);

          console.log(paymentDTO);

          // ê²°ì œ ì •ë³´ ì„œë²„ì— ì „ì†¡
          var paymentDTO = {
            roomPrice: roomPrice,
            roomServicePrice: roomServicePrice,
            totalPrice: paymentPrice,
            memberId: row.querySelector(".payBy")?.textContent?.trim() || "êµ¬ë§¤ì", // ì˜ˆì•½í•œ ë©¤ë²„ì˜ ID
            reservationId: reservationId,
            roomId: roomId
          };

          console.log(paymentDTO);

          fetch("/payment", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(paymentDTO),
          })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      location.reload();
                    } else {
                      alert("ì„œë²„ì— ê²°ì œ ì •ë³´ ì €ì¥ ì‹¤íŒ¨");
                    }
                  })
                  .catch(error => {
                    console.error("ê²°ì œ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    alert("ê²°ì œ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                  });
        }
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".delete-icon").forEach(icon => {
        icon.addEventListener("click", function () {
          const reservationId = this.getAttribute("data-reservation-id");
          let rowElement = this.closest("tr");

          if (!confirm("í•´ë‹¹ ì˜ˆì•½ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
          }

          fetch("/myPage/reservation/delete", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ reservationId: reservationId })
          })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + response.status);
                    }
                    return response.json();
                  })
                  .then(data => {
                    if (data.success) {
                      alert(data.message);

                      //  ì‚­ì œëœ í–‰ì„ ëª©ë¡ì—ì„œ ì œê±°
                      rowElement.remove();

                      //  ë‚¨ì€ ì˜ˆì•½ ê°œìˆ˜ í™•ì¸ í›„ ëª©ë¡ì´ ë¹„ì—ˆìœ¼ë©´ "ì˜ˆì•½ ë‚´ì—­ ì—†ìŒ" ë©”ì‹œì§€ í‘œì‹œ
                      checkAndUpdateReservationList();
                    } else {
                      throw new Error(data.message);
                    }
                  })
                  .catch(error => {
                    console.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
                  });
        });
      });

      //  ì˜ˆì•½ ê°œìˆ˜ í™•ì¸ í›„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
      function checkAndUpdateReservationList() {
        const tableBody = document.querySelector("tbody"); // ì˜ˆì•½ ëª©ë¡ í…Œì´ë¸”
        const noDataMessage = document.querySelector(".alert-warning"); // "ì˜ˆì•½ ë‚´ì—­ ì—†ìŒ" ë©”ì‹œì§€

        if (!tableBody || !noDataMessage) return;

        const remainingRows = tableBody.querySelectorAll("tr").length;

        if (remainingRows === 0) {
          // ğŸš€ í…Œì´ë¸”ì´ ë¹„ì—ˆì„ ë•Œ "ì˜ˆì•½ ë‚´ì—­ ì—†ìŒ" ë©”ì‹œì§€ í‘œì‹œ
          tableBody.innerHTML = ""; // í…Œì´ë¸” ë‚´ìš© ì œê±°
          noDataMessage.style.display = "block"; // ë©”ì‹œì§€ í‘œì‹œ
        }
      }

      //  ì‚­ì œ í›„ í˜„ì¬ í˜ì´ì§€ ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ ì¶”ê°€
      function reloadReservationList() {
        const currentPage = new URLSearchParams(window.location.search).get("page") || 0;

        fetch("/myPage/reservationList?page=" + currentPage)
                .then(response => response.text())
                .then(html => {
                  const parser = new DOMParser();
                  const newDoc = parser.parseFromString(html, "text/html");
                  const newTable = newDoc.querySelector(".table"); // ì˜ˆì•½ ëª©ë¡ í…Œì´ë¸” ì„ íƒ
                  document.querySelector(".table").innerHTML = newTable.innerHTML; // ê¸°ì¡´ ëª©ë¡ êµì²´
                  attachDeleteEvent(); // ì‚­ì œ ì´ë²¤íŠ¸ ë‹¤ì‹œ ë°”ì¸ë”©
                  initCountdownTimers();
                })
                .catch(error => console.error("ëª©ë¡ ê°±ì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
      }

      //  ì‚­ì œ ì´ë²¤íŠ¸ ë‹¤ì‹œ ë°”ì¸ë”©
      function attachDeleteEvent() {
        document.querySelectorAll(".delete-icon").forEach(icon => {
          icon.addEventListener("click", function () {
            const reservationId = this.getAttribute("data-reservation-id");
            let rowElement = this.closest("tr");

            if (!confirm("í•´ë‹¹ ì˜ˆì•½ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              return;
            }

            fetch("/myPage/reservation/delete", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ reservationId: reservationId })
            })
                    .then(response => {
                      if (!response.ok) {
                        throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + response.status);
                      }
                      return response.json();
                    })
                    .then(data => {
                      if (data.success) {
                        alert(data.message);
                        reloadReservationList();
                      } else {
                        throw new Error(data.message);
                      }
                    })
                    .catch(error => {
                      console.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                      alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
                    });
          });
        });
      }

      /* íƒ€ì´ë¨¸ ì´ˆê¸°í™” í•¨ìˆ˜ */
      function initCountdownTimers() {
        document.querySelectorAll(".countdown-timer").forEach(timer => {
          let timeRemaining = parseInt(timer.getAttribute("data-time-remaining"), 10);

          if (isNaN(timeRemaining) || timeRemaining <= 0) {
            timer.innerText = "ì‚­ì œë¨";
            return;
          }

          function updateTimer() {
            if (timeRemaining <= 0) {
              timer.querySelector("span").innerText = "00:00:00"; // 00:00:00 ê³ ì •
              return;
            }

            const hours = Math.floor(timeRemaining / 3600);
            const minutes = Math.floor((timeRemaining % 3600) / 60);
            const seconds = timeRemaining % 60;

            timer.querySelector("span").innerText =
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timeRemaining--;
          }


          updateTimer();
          setInterval(updateTimer, 1000);
        });
      }

      // ì˜ˆì•½ ìë™ ì‚­ì œ ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸
      document.querySelectorAll(".countdown-timer").forEach(timer => {
        let timeRemaining = parseInt(timer.getAttribute("data-time-remaining"), 10); // ì´ˆ ë‹¨ìœ„ ê°’

        if (isNaN(timeRemaining) || timeRemaining <= 0) {
          timer.innerText = "ì‚­ì œë¨";
          return;
        }

        function updateTimer() {
          if (timeRemaining <= 0) {
            timer.innerText = "ì‚­ì œë¨";
            return;
          }

          const hours = Math.floor(timeRemaining / 3600);
          const minutes = Math.floor((timeRemaining % 3600) / 60);
          const seconds = timeRemaining % 60;

          timer.querySelector("span").innerText = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
          timeRemaining--;
        }

        updateTimer();
        setInterval(updateTimer, 1000);
      });

      // ì˜ˆì•½ ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      document.querySelectorAll(".cancel-btn").forEach(button => {
        button.addEventListener("click", function () {
          const reservationId = this.getAttribute("data-reservation-id");

          if (!confirm("ì •ë§ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
          }

          fetch("/myPage/reservation/cancel", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "reservationId=" + encodeURIComponent(reservationId)
          })
                  .then(response => response.text())
                  .then(data => {
                    alert(data); // ì„œë²„ ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ

                    // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ ìœ ì§€í•˜ë©° ìƒˆë¡œê³ ì¹¨
                    const currentPage = new

                    URLSearchParams(window.location.search).get("page") || 0;
                    window.location.href = "/myPage/reservationList?page=" + currentPage;
                  })
                  .catch(error => {
                    console.error("ì˜ˆì•½ ì·¨ì†Œ ì˜¤ë¥˜:", error);
                    alert("ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                  });
        }, { once: true }); // ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€
      });
    });
  </script>
</div>
<div th:replace="~{fragments/footer::footer}"></div>
</body>
</html>