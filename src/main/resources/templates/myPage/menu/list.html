<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서비스 주문 페이지</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h2>서비스 카테고리</h2>
    <div id="categories" class="d-flex flex-wrap gap-3"></div>

    <h2 class="mt-4">메뉴 목록</h2>
    <div id="menus" class="row"></div>

    <h2 class="mt-4">장바구니</h2>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>메뉴 이름</th>
            <th>수량</th>
            <th>가격</th>
            <th>삭제</th>
        </tr>
        </thead>
        <tbody id="cartItems"></tbody>
    </table>
    <button class="btn btn-primary" id="placeOrder">주문하기</button>
</div>

<script>
    let cart = [];

    function loadCategories() {
        $.get("/api/categories", function(categories) {
            categories.forEach(category => {
                $('#categories').append(`<button class="btn btn-outline-primary category-btn" data-id="${category.serviceCateId}">${category.serviceCateName}</button>`);
            });
        });
    }

    $(document).on('click', '.category-btn', function() {
        const categoryId = $(this).data('id');
        $('#menus').empty();
        $.get(`/api/user/menus?serviceCateId=${categoryId}`, function(menus) {
            let html = "";
            menus.forEach(menu => {
                // 이미지 경로 설정
                const imagePath = menu.imagePath && menu.imagePath.length > 0
                    ? `/upload/${menu.imagePath[0]}`  // 이미지가 있다면 첫 번째 이미지 사용
                    : '/img/default_img.jpg'; // 기본 이미지 사용

                html += `
            <div class='col-md-4'>
                <div class='card'>
                    <div class='card-body'>
                        <img src='${imagePath}' class='card-img-top' alt='${menu.serviceMenuName}' width='200px'>
                        <h5 class='card-title'>${menu.serviceMenuName}</h5>
                        <p class='card-text'>${menu.serviceMenuInfo}</p>
                        <p class='card-text'>가격: ${menu.serviceMenuPrice}원</p>
                        <button class='btn btn-success add-to-cart'
                                data-id='${menu.serviceMenuId}'
                                data-name='${menu.serviceMenuName}'
                                data-price='${menu.serviceMenuPrice}'>장바구니 추가</button>
                    </div>
                </div>
            </div>`;
            });
            $('#menus').html(html);
        });
    });

    $(document).on('click', '.add-to-cart', function() {
        const menuId = $(this).data('id');
        const menuName = $(this).data('name');
        const menuPrice = $(this).data('price');

        const existingItem = cart.find(item => item.id === menuId);
        if (existingItem) {
            existingItem.count++;
        } else {
            cart.push({ id: menuId, name: menuName, price: menuPrice, count: 1 });
        }
        updateCart();
    });

    function updateCart() {
        $('#cartItems').empty();
        cart.forEach(item => {
            $('#cartItems').append(`
                    <tr>
                        <td>${item.name}</td>
                        <td><input type='number' min='1' value='${item.count}' class='update-quantity' data-id='${item.id}'></td>
                        <td>${item.price * item.count}원</td>
                        <td><button class='btn btn-danger remove-item' data-id='${item.id}'>삭제</button></td>
                    </tr>
                `);
        });
    }

    $(document).on('change', '.update-quantity', function() {
        const menuId = $(this).data('id');
        const newCount = $(this).val();
        const item = cart.find(item => item.id === menuId);
        if (item) {
            item.count = parseInt(newCount);
        }
        updateCart();
    });

    $(document).on('click', '.remove-item', function() {
        const menuId = $(this).data('id');
        cart = cart.filter(item => item.id !== menuId);
        updateCart();
    });

    $('#placeOrder').click(function() {
        if (cart.length === 0) {
            alert('장바구니가 비어 있습니다.');
            return;
        }

        let orderData = cart.map(item => ({
            serviceMenuId: item.id,
            orderCount: item.count
        }));

        $.ajax({
            url: "/api/orders",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(orderData),
            success: function() {
                alert("주문이 완료되었습니다!");
                cart = [];
                updateCart();
                // 주문 후, memberId를 포함하여 주문 내역 페이지로 이동
                const memberId = 1; // 실제 로그인된 사용자의 memberId로 변경 필요
                window.location.href = `/myPage/order/history/${memberId}`; // URL에 memberId 추가
            },
            error: function(xhr) {
                alert("주문 처리 중 오류가 발생했습니다.");
                console.error("주문 오류:", xhr.responseText);
            }
        });
    });

    $(document).ready(loadCategories);
</script>
</body>
</html>