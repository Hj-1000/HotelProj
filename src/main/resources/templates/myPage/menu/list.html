<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유저 주문 페이지</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .card-img-top {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .card-body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .category-btn {
            margin: 5px;
        }
        .card-text {
            font-size: 1rem;
        }
        #cartItems td, #cartItems th {
            text-align: center;
        }
    </style>
</head>
<body>
<!-- 헤더 -->
<div th:replace="~{fragments/header::header}"></div>

<!-- 본문 -->
<div class="container mt-4">
    <h2 class="text-center">유저 주문 페이지</h2>

    <!-- 카테고리 버튼 -->
    <div class="mb-4 text-center">
        <h5>카테고리 선택</h5>
        <div id="categoryButtons" class="btn-group" role="group">
            <!-- 카테고리 버튼 동적 생성 -->
        </div>
    </div>

    <!-- 메뉴 리스트 -->
    <div id="menus" class="row row-cols-1 row-cols-md-3 g-4">
        <!-- 메뉴 카드 동적 생성 -->
    </div>

    <!-- 장바구니 -->
    <div class="mt-4">
        <h5>장바구니</h5>
        <table class="table table-bordered" id="cartTable">
            <thead>
            <tr>
                <th>메뉴</th>
                <th>수량</th>
                <th>가격</th>
                <th>삭제</th>
            </tr>
            </thead>
            <tbody id="cartItems">
            <!-- 장바구니 항목 동적 생성 -->
            </tbody>
        </table>
    </div>
</div>

<!-- 푸터 -->
<div th:replace="~{fragments/footer::footer}"></div>

<!-- JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetchCategories();
        fetchCart();
    });

    // 카테고리 불러오기
    function fetchCategories() {
        fetch("/api/categories")
            .then(response => response.json())
            .then(categories => {
                console.log("카테고리 데이터:", categories);
                const categoryContainer = document.getElementById("categoryButtons");
                categoryContainer.innerHTML = "";
                categories.forEach(category => {
                    const button = document.createElement("button");
                    button.textContent = category.serviceCateName;
                    button.classList.add("btn", "btn-outline-primary", "category-btn");
                    button.onclick = () => fetchMenus(category.serviceCateId);
                    categoryContainer.appendChild(button);
                });
            })
            .catch(error => console.error("카테고리 불러오기 오류:", error));
    }

    // 메뉴 불러오기
    function fetchMenus(categoryId) {
        fetch(`/api/menus?serviceCateId=${categoryId}`)
            .then(response => response.json())
            .then(menus => {
                console.log("메뉴 데이터:", menus);
                const menuContainer = document.getElementById("menus");
                menuContainer.innerHTML = "";
                menus.forEach(menu => {
                    const menuItem = document.createElement("div");
                    menuItem.classList.add("col");

                    const imageUrl = (menu.serviceMenuImageDTOList.length > 0)
                        ? `/upload/${menu.serviceMenuImageDTOList[0].imagePath}`
                        : "/images/default.jpg"; // 기본 이미지 설정

                    menuItem.innerHTML = `
                    <div class="card">
                        <img src="${imageUrl}" class="card-img-top" alt="${menu.serviceMenuName}">
                        <div class="card-body text-center">
                            <h5 class="card-title">${menu.serviceMenuName}</h5>
                            <p class='card-text'>${menu.serviceMenuInfo}</p>
                            <p class="card-text">${menu.serviceMenuPrice}원</p>
                            <button class="btn btn-success" onclick="addToCart(${menu.serviceMenuId}, '${menu.serviceMenuName}', ${menu.serviceMenuPrice})">추가</button>
                        </div>
                    </div>
                `;
                    menuContainer.appendChild(menuItem);
                });
            })
            .catch(error => console.error("메뉴 불러오기 오류:", error));
    }

    // 장바구니에 메뉴 추가하는 함수
    function addToCart(menuId, menuName, price) {
        fetch("/api/cart", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                serviceMenuId: menuId,
                serviceMenuName: menuName,
                serviceMenuPrice: price,
                count: 1 // 수량을 count로 명확히 지정
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        console.error('장바구니 추가 실패:', error);
                        alert(error.message || '장바구니 추가 오류');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    console.log("장바구니 추가 성공:", data);
                    fetchCart(); // 최신 장바구니 데이터 반영
                }
            })
            .catch(error => {
                console.error("장바구니 추가 오류:", error);
                alert('장바구니 추가 중 오류가 발생했습니다.');
            });
    }

    // 장바구니 불러오기
    function fetchCart() {
        fetch("/api/cart")
            .then(response => response.json())
            .then(cartData => {
                console.log("장바구니 데이터:", cartData);

                const cartItems = Array.isArray(cartData) ? cartData : cartData.items || [];

                const cartContainer = document.getElementById("cartItems");
                cartContainer.innerHTML = "";

                cartItems.forEach(item => {
                    const itemRow = document.createElement("tr");

                    // 수량 입력 필드 추가
                    itemRow.innerHTML = `
                    <td>${item.serviceMenuName}</td>
                    <td>
                        <input type="number" class="form-control" min="1" value="${item.count}"
                            onchange="updateQuantity(${item.serviceCartItemId}, this.value)">
                    </td>

                    <td>${item.serviceMenuPrice * item.count}원</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.serviceCartItemId})">삭제</button>
                    </td>
                `;
                    cartContainer.appendChild(itemRow);
                });

                // 수량이 0인 아이템 삭제
                cartItems.forEach(item => {
                    if (item.count <= 0) {
                        removeFromCart(item.serviceCartItemId);
                    }
                });
            })
            .catch(error => console.error("장바구니 불러오기 오류:", error));
    }

    // 장바구니에서 수량 업데이트
    function updateQuantity(serviceCartItemId, count , serviceMenuId ) {
        console.log(serviceCartItemId)
        console.log(count)
        console.log(serviceMenuId)


        // 요청을 보낼 때 반드시 serviceCartItemId와 count를 포함
        fetch(`/api/updateCartItem`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                serviceCartItemId: serviceCartItemId,  // 카트 아이템 아이템
                count: count        ,         // 수량
                ServiceMenuId: serviceMenuId
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(errorMessage => {
                        console.error("서버 오류:", errorMessage);
                        alert(errorMessage || '수량 업데이트 오류');
                    });
                }

                return response.json().then(data => {
                    console.log("서버에서 받은 데이터:", data);
                    if (data) {
                        console.log("수량 업데이트 성공:", data);
                        fetchCart(); // 최신 장바구니 데이터 반영
                    } else {
                        console.error("서버에서 예상한 데이터가 반환되지 않았습니다.");
                    }
                });
            })
            .catch(error => {
                console.error("수량 업데이트 오류:", error);
                alert('수량 업데이트 중 오류가 발생했습니다.');
            });

    }



    // 장바구니에서 삭제
    function removeFromCart(serviceCartItemId) {
        console.log("삭제할 카트 아이템 아이디:", serviceCartItemId);  // 메뉴 ID가 제대로 전달되는지 확인

        fetch(`/api/cartItem/${serviceCartItemId}`, {
            method: "DELETE"
        })
            .then(response => response.json())
            .then(data => {
                console.log("장바구니 삭제 성공:", data);
                fetchCart(); // 최신 장바구니 데이터 반영
            })
            .catch(error => console.error("장바구니 삭제 오류:", error));
    }
</script>
</body>
</html>
