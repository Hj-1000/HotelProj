<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유저 주문 페이지</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/user.css}">
    <style>
        .card {
            height: 100%;
        }

        .card-img-top {
            width: 100%;
            height: 150px; /* 원하는 높이로 조정 */
            object-fit: cover; /* 비율을 유지하면서 잘리지 않도록 설정 */
        }

        .card-body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-text {
            font-size: 0.9rem; /* 폰트 크기 조정 */
        }
    </style>
</head>
<body>
<!--헤더-->
<div th:replace="~{fragments/header::header}"></div>

<!--본문-->
<div layout:fragment="content">

    <div class="container list-wrapper">
        <h2>유저 주문 페이지</h2>
        <div class="card">
            <!-- 카테고리 선택 버튼들 -->
            <div class="mb-3 text-center"> <!-- text-center로 가운데 정렬 -->
                <h5>카테고리 선택</h5>
                <div class="btn-group" role="group" aria-label="Category Buttons">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='/myPage/menu/list'">전체보기</button>
                    <th:block th:each="category : ${serviceCateDTOS}">
                        <button type="button" class="btn btn-secondary"
                                th:onclick="'window.location.href=\'/myPage/menu/list?serviceCateId=' + ${category.serviceCateId} + '\''"
                                th:text="${category.serviceCateName}"></button>
                    </th:block>
                </div>
            </div>

            <div class="card-body">
                <h5 class="card-title">서비스 메뉴 목록</h5>

                <!-- 메뉴 카드 그리드 -->
                <div class="row row-cols-1 row-cols-md-5 g-4">
                    <th:block th:if="${#lists.isEmpty(serviceMenuDTOS)}">
                        <div class="col-12">
                            <div class="alert alert-warning" role="alert">
                                등록된 서비스 메뉴가 없습니다.
                            </div>
                        </div>
                    </th:block>

                    <th:block th:unless="${#lists.isEmpty(serviceMenuDTOS)}">
                        <th:block th:each="data, status: ${serviceMenuDTOS}">
                            <div class="col">
                                <div class="card">
                                    <a th:href="@{/roomService/menu/read(serviceMenuId=${data.serviceMenuId})}">
                                        <img th:src="@{'/upload/' + ${data.serviceMenuImageDTOList[0].imagePath}}" class="card-img-top" alt="Service Menu Image">
                                    </a>
                                    <div class="card-body">
                                        <!-- 카테고리명 가운데 정렬 및 폰트 크기 증가 -->
                                        <p class="card-text text-center" style="font-size: 1.25rem;">
                                            <span th:text="${data.serviceCateName}"></span>
                                        </p>
                                        <p class="card-text">
                                            <strong>메뉴이름:</strong><span th:text="${data.serviceMenuName}"></span>
                                        </p>
                                        <p class="card-text" >
                                            <strong>메뉴설명:</strong><span th:text="${data.serviceMenuInfo}"></span>
                                        </p>
                                        <p class="card-text">
                                            <strong>상태: </strong><span th:text="${data.serviceMenuStatus.description}"></span>
                                        </p>
                                        <p class="card-text">
                                            <strong>가격: </strong><span th:text="${data.serviceMenuPrice}"></span>
                                        </p>
                                        <a th:href="@{/roomService/menu/delete(serviceMenuId=${data.serviceMenuId})}" class="btn btn-danger">삭제</a>
                                    </div>
                                </div>
                            </div>
                        </th:block>
                    </th:block>
                </div>
            </div>
        </div>
    </div>
</div>



<!--푸터-->
<div th:replace="~{fragments/footer::footer}"></div>

<script>
    let cart = [];

    function loadCategories() {
        $.get("/api/categories", function(categories) {
            categories.forEach(category => {
                $('#categories').append(`<button class="btn btn-outline-primary category-btn" data-id="${category.serviceCateId}">${category.serviceCateName}</button>`);
            });
        });
    }

    $(document).on('click', '.category-btn', function() {
        const categoryId = $(this).data('id');
        $('#menus').empty();
        $.get(`/api/user/menus?serviceCateId=${categoryId}`, function(menus) {
            let html = "";
            menus.forEach(menu => {
                // 이미지 경로 설정
                const imagePath = menu.imagePath && menu.imagePath.length > 0
                    ? `/upload/${menu.imagePath[0]}`  // 이미지가 있다면 첫 번째 이미지 사용
                    : '/img/default_img.jpg'; // 기본 이미지 사용

                html += `
            <div class='col-md-4'>
                <div class='card'>
                    <div class='card-body'>
                        <img src='${imagePath}' class='card-img-top' alt='${menu.serviceMenuName}' width='200px'>
                        <h5 class='card-title'>${menu.serviceMenuName}</h5>
                        <p class='card-text'>${menu.serviceMenuInfo}</p>
                        <p class='card-text'>가격: ${menu.serviceMenuPrice}원</p>
                        <button class='btn btn-success add-to-cart'
                                data-id='${menu.serviceMenuId}'
                                data-name='${menu.serviceMenuName}'
                                data-price='${menu.serviceMenuPrice}'>장바구니 추가</button>
                    </div>
                </div>
            </div>`;
            });
            $('#menus').html(html);
        });
    });

    $(document).on('click', '.add-to-cart', function() {
        const menuId = $(this).data('id');
        const menuName = $(this).data('name');
        const menuPrice = $(this).data('price');

        const existingItem = cart.find(item => item.id === menuId);
        if (existingItem) {
            existingItem.count++;
        } else {
            cart.push({ id: menuId, name: menuName, price: menuPrice, count: 1 });
        }
        updateCart();
    });

    function updateCart() {
        $('#cartItems').empty();
        cart.forEach(item => {
            $('#cartItems').append(`
                    <tr>
                        <td>${item.name}</td>
                        <td><input type='number' min='1' value='${item.count}' class='update-quantity' data-id='${item.id}'></td>
                        <td>${item.price * item.count}원</td>
                        <td><button class='btn btn-danger remove-item' data-id='${item.id}'>삭제</button></td>
                    </tr>
                `);
        });
    }

    $(document).on('change', '.update-quantity', function() {
        const menuId = $(this).data('id');
        const newCount = $(this).val();
        const item = cart.find(item => item.id === menuId);
        if (item) {
            item.count = parseInt(newCount);
        }
        updateCart();
    });

    $(document).on('click', '.remove-item', function() {
        const menuId = $(this).data('id');
        cart = cart.filter(item => item.id !== menuId);
        updateCart();
    });

    $('#placeOrder').click(function() {
        if (cart.length === 0) {
            alert('장바구니가 비어 있습니다.');
            return;
        }

        let orderData = cart.map(item => ({
            serviceMenuId: item.id,
            orderCount: item.count
        }));

        $.ajax({
            url: "/api/orders",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(orderData),
            success: function() {
                alert("주문이 완료되었습니다!");
                cart = [];
                updateCart();
                // 주문 후, memberId를 포함하여 주문 내역 페이지로 이동
                const memberId = 1; // 실제 로그인된 사용자의 memberId로 변경 필요
                window.location.href = `/myPage/order/history/${memberId}`; // URL에 memberId 추가
            },
            error: function(xhr) {
                alert("주문 처리 중 오류가 발생했습니다.");
                console.error("주문 오류:", xhr.responseText);
            }
        });
    });

    $(document).ready(loadCategories);
</script>
</body>
</html>
