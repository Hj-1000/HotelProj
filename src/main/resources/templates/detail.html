<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>객실 상세보기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr 한국어 로케일 추가 -->
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>
    <link rel="stylesheet" th:href="@{/css/user.css}">
    <link rel="stylesheet" th:href="@{/css/detail.css}">
</head>
<body>
<div th:replace="~{fragments/header::header}"></div>
<div layout:fragment="content">

    <!-- 예약 모달 -->
    <div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="reservationModalLabel">호텔 예약하기</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reservationForm">
                        <input type="hidden" id="roomId" name="roomId" th:value="${room.roomId}">

                        <div class="mb-3">
                            <label for="reservationCount" class="form-label">
                                예약 인원 <span id="recommendedCountText"></span>
                            </label>
                            <select class="form-control" id="reservationCount" name="count" required>
                                <option value="1">1명</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="reservationDates" class="form-label">숙박 기간</label>
                            <input type="text" class="form-control" id="reservationDates" placeholder="체크인 - 체크아웃" readonly>

                            <!-- 실제 체크인, 체크아웃 날짜를 저장할 hidden input -->
                            <input type="hidden" id="checkInDate" name="checkInDate">
                            <input type="hidden" id="checkOutDate" name="checkOutDate">
                        </div>

                        <div class="mb-3">
                            <label for="dayCount" class="form-label">숙박일</label>
                            <input type="text" class="form-control" id="dayCount" name="dayCount" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="totalPrice" class="form-label">총 금액</label>
                            <input type="text" class="form-control" id="totalPrice" name="totalPrice" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" id="confirmReservation" class="btn btn-primary">예약하기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 객실 배너 이미지 -->
    <section class="room-banner">
        <div class="banner-container">
            <img th:if="${room.bannerImage != null && !room.bannerImage.isEmpty()}"
                 th:src="@{'/upload/' + ${room.bannerImage}}"
                 alt="객실 배너 이미지" class="room-banner-image">
        </div>
    </section>
    <!-- 예약 정보 및 버튼 -->
    <section class="reservation-info-wrapper btn10">
        <div class="room-card reservation-info d-flex justify-content-between align-items-center"
             th:data-room-id="${room.roomId}"
             th:data-stay-start="${room.stayStart}"
             th:data-stay-end="${room.stayEnd}"
             th:data-room-type="${room.roomType}">
            <div>
                <p class="period"><strong>예약 기간:</strong> <span th:text="${room.reservationStart}"></span> ~ <span th:text="${room.reservationEnd}"></span></p>
                <p class="period"><strong>숙박 기간:</strong> <span th:text="${room.stayStart}"></span> ~ <span th:text="${room.stayEnd}"></span></p>
            </div>
            <div>
                <div th:data-room-id="${room.roomId}">
                    <button class="btn btn-outline-dark"><i class="fas fa-share"></i> 공유하기</button>
                    <button class="btn btn-dark btn-book" data-room-id="${room.roomId}" data-bs-toggle="modal" data-bs-target="#reservationModal">
                        <i class="fas fa-bed"></i> 예약하기
                    </button>
                </div>
                <span id="roomType" th:data-room-type="${room.roomType}" style="display: none;"></span>


                <input type="hidden" id="roomPrice" th:value="${room.formattedRoomPrice}">
            </div>
        </div>
    </section>
    <div class="container mt-4">
        <!-- 주요 혜택 -->
        <section class="room-details mt-5">
            <h2 class="mb-4">주요 혜택</h2>
            <div class="room-item-wrapper">
                <div class="room-item py-4" th:each="image : ${room.roomImageDTOList}">
                    <div class="room-item-box">
                        <!-- 객실 이미지 -->
                        <div class="room-image col-md-4">
                            <img class="w-100"
                                 th:src="@{'/upload/' + ${#strings.replace(image.imagePath, 'c:/data/', '')}}"
                                 alt="객실 상세 이미지"/>
                        </div>
                        <!-- 객실 설명 -->
                        <div class="room-text col-md-8">
                            <h2 class="room-details-title" th:text="${image.imageTitle} ?: '이미지 제목 없음'"></h2>
                            <p class="room-details-description"
                               th:utext="${#strings.replace(image.imageDescription, '\n', '<br/>') ?: '설명이 없습니다.'}"></p>
                        </div>
                    </div>
                    <!-- 구분선 -->
                    <hr class="room-divider">
                </div>
            </div>
            <!-- 이미지가 없는 경우 -->
            <div th:if="${room.roomImageDTOList == null or room.roomImageDTOList.isEmpty()}" class="text-center mt-4">
                <p class="text-muted">객실 상세 이미지가 없습니다.</p>
            </div>
        </section>

        <!-- 유의사항 -->
        <section class="notice mb-5 p-4 border rounded">
            <h3 class="mb-3 fw-bold">유의사항</h3>
            <ul class="list-unstyled">
                <li class="mb-2">
                    <i class="fas fa-check-circle text-primary me-2"></i>
                    체크인 시간은 예약 당일 <strong>오전 11:00 AM</strong>부터이며, 체크아웃 시간은 마지막 날 <strong>오전 10:00 AM</strong>까지입니다.
                </li>
                <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i> 상기 요금에는 세금 및 봉사료가 포함되어 있습니다.</li>
                <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i> 요금은 상시 변경되며, 예약 시점의 요금과 상이할 수 있습니다.</li>
                <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i> 주차장 이용 시 입차 기준 15,000원(24시간)의 주차료가 발생합니다.</li>
                <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i> 호텔 수요에 따라 금액 변동이 있을 수 있습니다.</li>
                <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i> 클럽조선 1만원 할인권과 VIP 등급 할인 적용 가능합니다.</li>
                <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i> 호텔 사정에 따라 조기 마감될 수 있습니다.</li>
            </ul>
        </section>


        <!-- 리뷰  -->

        <!-- 수정 모달 -->
        <div class="modal fade" id="editReviewModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">리뷰 수정</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editReviewId">
                        <div class="mb-3">
                            <label for="editReviewText" class="form-label">리뷰 내용</label>
                            <textarea id="editReviewText" class="form-control"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editRating" class="form-label">평점</label>
                            <select id="editRating" class="form-control">
                                <option value="5">★★★★★ (5점)</option>
                                <option value="4">★★★★☆ (4점)</option>
                                <option value="3">★★★☆☆ (3점)</option>
                                <option value="2">★★☆☆☆ (2점)</option>
                                <option value="1">★☆☆☆☆ (1점)</option>
                            </select>
                        </div>
                        <button type="button" id="saveReviewChanges" class="btn btn-primary">수정 완료</button>
                    </div>
                </div>
            </div>
        </div>

        <!--  객실 리뷰 -->
        <section class="review-section mb-5 p-4 border rounded">
            <h3 class="mb-3 fw-bold">객실 리뷰</h3>
            <div sec:authorize="isAuthenticated()">
                <form id="reviewForm">
                    <input type="hidden" id="reviewRoomId" name="roomId" th:value="${room.roomId != null ? room.roomId : 0}">
                    <input type="hidden" id="reviewMemberId" name="memberId" th:value="${memberId}">

                    <div class="star-warp mb-3">
                        <label class="form-label">평점 (1~5점)</label>
                        <div id="star-rating">
                            <div id="star-click-hint">CLICK!</div>
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>
                        <input type="hidden" id="rating" name="rating" value="5">
                    </div>

                    <div class="mb-3">
                        <label for="reviewText" class="form-label">리뷰 내용</label>
                        <textarea id="reviewText" name="reviewText" class="form-control" rows="3" required></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" id="submitReview">리뷰 작성</button>
                </form>
            </div>

            <!--  로그인하지 않은 경우 리뷰 작성 불가 -->
            <div sec:authorize="!isAuthenticated()">
                <p class="text-danger">리뷰 작성을 하려면 <a href="/login">로그인</a>이 필요합니다.</p>
            </div>

            <hr>

            <!--  리뷰 목록 -->
            <h4 class="mt-4 mb-4">다른 이용자 리뷰</h4>
            <div id="reviewList">

                <!-- 리뷰가 없을 경우 -->
                <div id="noReviewMessage" class="text-center mt-4" style="display: none;">
                    <p class="text-muted">등록된 후기가 없습니다.</p>
                </div>

            </div>
        </section>

        <!-- 로그인된 상태 -->
        <div sec:authorize="isAuthenticated()">
            <script th:inline="javascript">
                var isLoggedIn = true;
                console.log("isLoggedIn:", isLoggedIn);
            </script>
        </div>

        <!-- 로그인되지 않은 상태 -->
        <div sec:authorize="!isAuthenticated()">
            <script th:inline="javascript">
                var isLoggedIn = false;
                console.log("isLoggedIn:", isLoggedIn);
            </script>
        </div>
    </div>

    <!-- 상단으로 이동 버튼 -->
    <button id="scrollTopButton" class="scroll-top-btn">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script>
        /* 상세보기 이미지 , 텍스트 fade 함수 */
        document.addEventListener("DOMContentLoaded", function () {
            const roomItems = document.querySelectorAll(".room-item-box");

            const observerOptions = {
                root: null,
                rootMargin: "0px",
                threshold: 0.2
            };

            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add("active");

                        setTimeout(() => {
                            const textElement = entry.target.querySelector(".room-text");
                            if (textElement) {
                                textElement.classList.add("active");
                            }
                        }, 500);
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            roomItems.forEach(item => {
                observer.observe(item);
            });
        });

        /* 스크롤 함수 */
        document.addEventListener("DOMContentLoaded", function () {
            const reservationInfo = document.querySelector(".reservation-info-wrapper");

            window.addEventListener("scroll", function () {
                if (window.scrollY > 700) {
                    reservationInfo.classList.add("scrolled");
                } else {
                    reservationInfo.classList.remove("scrolled");
                }
            });
        });

        /* 체크인 체크아웃 기본값 설정 */
        document.addEventListener("DOMContentLoaded", function () {
            function getFormattedDateTime(offsetDays = 0) {
                let now = new Date();
                now.setDate(now.getDate() + offsetDays);
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // 시간대 보정
                return now.toISOString().slice(0, 16); // "YYYY-MM-DDTHH:mm" 형식
            }

            let checkInInput = document.getElementById("checkInDate");
            let checkOutInput = document.getElementById("checkOutDate");

            if (checkInInput) {
                checkInInput.value = getFormattedDateTime();
            }
            if (checkOutInput) {
                checkOutInput.value = getFormattedDateTime(1); // 하루 뒤 기본값
            }

            checkInInput.addEventListener("change", function () {
                let checkInDate = new Date(checkInInput.value);
                let minCheckOutDate = new Date(checkInDate);
                minCheckOutDate.setDate(minCheckOutDate.getDate() + 1);
                checkOutInput.min = minCheckOutDate.toISOString().slice(0, 16);
            });
        });

        let reservationModal;

        document.addEventListener("DOMContentLoaded", function () {
            // 예약 모달 초기화
            const reservationModalElement = document.getElementById('reservationModal');
            if (reservationModalElement) {
                reservationModal = new bootstrap.Modal(reservationModalElement);
            } else {
                console.error("ERROR: 예약 모달을 찾을 수 없습니다.");
                return;
            }

            updateRoomReservationStatus(); // 방 예약 상태 업데이트

            // 체크인 & 체크아웃 날짜 입력 필드 가져오기
            const checkInInput = document.getElementById("checkInDate");
            const checkOutInput = document.getElementById("checkOutDate");

            if (!checkInInput || !checkOutInput) {
                console.error("ERROR: 체크인 또는 체크아웃 입력 필드를 찾을 수 없습니다.");
                return;
            }

            // 기존 이벤트 리스너 제거 (중복 방지)
            checkInInput.removeEventListener("change", updateCheckOutMinDate);
            checkOutInput.removeEventListener("change", calculateStayAndPrice);

            // 이벤트 리스너 추가
            checkInInput.addEventListener("change", function () {
                console.log("체크인 날짜 변경됨:", checkInInput.value);
                updateCheckOutMinDate();
                calculateStayAndPrice();
            });

            checkOutInput.addEventListener("change", function () {
                console.log("체크아웃 날짜 변경됨:", checkOutInput.value);
                calculateStayAndPrice();
            });
        });


        /* URL에서 roomID 가져오기 */
        function getRoomIdFromURL() {
            const pathSegments = window.location.pathname.split("/");
            return pathSegments[pathSegments.length - 1];
        }

        /* 버튼 클릭시  로그인 , 비로그인 예외처리 및 버튼 함수*/
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll('.btn-book').forEach(button => {
                button.addEventListener("click", function (e) {
                    if (!isLoggedIn) {
                        alert("로그인이 필요합니다.");
                        window.location.href = "/login";
                        return;
                    }

                    let roomCard = button.closest(".room-card");
                    if (!roomCard) {
                        console.error("Error: roomCard element not found.");
                        return;
                    }

                    //  URL에서 roomId 가져오기
                    let roomId = getRoomIdFromURL();
                    let stayStart = roomCard.dataset.stayStart;
                    let stayEnd = roomCard.dataset.stayEnd;
                    let roomPriceElement = document.getElementById("roomPrice");
                    let roomPrice = roomPriceElement ? roomPriceElement.value : null;

                    // roomId가 유효한지 확인 후 진행
                    if (!roomId || isNaN(roomId)) {
                        console.error("Error: Room ID is invalid. Value:", roomId);
                        alert("객실 정보를 불러올 수 없습니다.");
                        return;
                    }

                    if (!stayStart || !stayEnd) {
                        console.error("Error: Stay start or end date is missing.");
                        alert("숙박 가능 날짜 정보를 불러올 수 없습니다.");
                        return;
                    }

                    console.log(" Room ID:", roomId);
                    console.log(" Check-in available from:", stayStart);
                    console.log(" Check-out available until:", stayEnd);

                    if (roomPrice) {
                        document.getElementById("totalPrice").value = roomPrice;
                    } else {
                        document.getElementById("totalPrice").value = "가격 미정";
                    }

                    const checkInInput = document.getElementById("checkInDate");
                    const checkOutInput = document.getElementById("checkOutDate");
                    const reservationCount = document.getElementById("reservationCount");
                    const recommendedText = document.getElementById("recommendedCountText");

                    checkInInput.min = stayStart;
                    checkInInput.max = stayEnd;
                    checkOutInput.min = stayStart;
                    checkOutInput.max = stayEnd;

                    checkInInput.removeEventListener("change", updateCheckOutMinDate);
                    checkInInput.addEventListener("change", updateCheckOutMinDate);

                    let maxPeople = getMaxPeopleByRoomType(roomType);
                    let recommendedTextValue = getRecommendedTextByRoomType(roomType);

                    reservationCount.innerHTML = ""; // 기존 옵션 제거

                    for (let i = 1; i <= maxPeople; i++) {
                        let option = document.createElement("option");
                        option.value = i;
                        option.text = `${i}명`;
                        reservationCount.appendChild(option);
                    }

                    recommendedText.innerText = recommendedTextValue;

                    //  모달에 roomId 설정
                    document.getElementById("roomId").value = roomId;
                    reservationModal.show();
                });
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            let roomTypeElement = document.getElementById("roomType");

            if (!roomTypeElement || !roomTypeElement.dataset.roomType) {
                console.warn(" roomType 데이터가 존재하지 않음. 다른 방법으로 가져옵니다...");

                let roomCard = document.querySelector(".room-card"); // room-card에서 가져오기
                if (roomCard && roomCard.dataset.roomType) {
                    roomTypeElement = roomCard;
                }
            }

            if (roomTypeElement) {
                const roomType = roomTypeElement.dataset.roomType;
                console.log(" roomType (최종) ->", roomType);

                if (roomType) {
                    const recommendedText = getRecommendedTextByRoomType(roomType);
                    const recommendedTextElement = document.getElementById("recommendedCountText");

                    if (recommendedTextElement) {
                        recommendedTextElement.innerHTML = `<span style="color: orange; font-weight: bold;">${recommendedText}</span>`;
                    } else {
                        console.error("ERROR: Element with ID 'recommendedCountText' not found.");
                    }
                } else {
                    console.warn(" roomType 값이 비어 있음!");
                }
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            const reservationModal = document.getElementById("reservationModal");

            // 모달 열릴 때 실행할 이벤트
            reservationModal.addEventListener("shown.bs.modal", function () {
                const roomCard = document.querySelector(".room-card");
                const roomId = roomCard.dataset.roomId;
                const roomType = roomCard.dataset.roomType;
                const stayStart = roomCard.dataset.stayStart;
                const stayEnd = roomCard.dataset.stayEnd;

                console.log(" roomType (최종) ->", roomType);
                console.log(" Room ID:", roomId);

                document.getElementById("roomId").value = roomId;

                // 예약 인원 및 추천 텍스트 업데이트
                updateReservationCountOptions(roomType);
                updateRecommendedCountText(roomType);

                // 체크인 & 체크아웃 날짜 설정
                document.getElementById("checkInDate").min = stayStart;
                document.getElementById("checkInDate").max = stayEnd;
                document.getElementById("checkOutDate").min = stayStart;
                document.getElementById("checkOutDate").max = stayEnd;
            });
        });

        //  예약 인원 옵션 업데이트 함수
        function updateReservationCountOptions(roomType) {
            const maxPeople = getMaxPeopleByRoomType(roomType);
            const reservationCount = document.getElementById("reservationCount");

            reservationCount.innerHTML = ""; // 기존 옵션 제거
            for (let i = 1; i <= maxPeople; i++) {
                let option = document.createElement("option");
                option.value = i;
                option.text = `${i}명`;
                reservationCount.appendChild(option);
            }
        }

        // 추천 인원 텍스트 업데이트 함수
        function updateRecommendedCountText(roomType) {
            const recommendedText = getRecommendedTextByRoomType(roomType);
            document.getElementById("recommendedCountText").innerHTML = `<span style="color: orange; font-weight: bold;">${recommendedText}</span>`;
        }

        function getMaxPeopleByRoomType(roomType) {
            const roomCapacity = {
                "Single": 1,
                "Double": 2,
                "Suite": 4,
                "Deluxe": 5,
                "Family": 6
            };
            return roomCapacity[roomType] || 1;
        }

        function getRecommendedTextByRoomType(roomType) {
            const recommendedTextMap = {
                "Single": "(추천 인원 : 1명)",
                "Double": "(추천 인원 : 1~2명)",
                "Suite": "(추천 인원 : 2~4명)",
                "Deluxe": "(추천 인원 : 4~5명)",
                "Family": "(추천 인원 : 4~6명)"
            };
            return recommendedTextMap[roomType] || "";
        }

        // 체크인 날짜 변경 시 체크아웃 최소 날짜 설정
        function updateCheckOutMinDate() {
            const checkInInput = document.getElementById("checkInDate");
            const checkOutInput = document.getElementById("checkOutDate");

            let checkInDate = new Date(checkInInput.value);
            if (!isNaN(checkInDate.getTime())) {
                let minCheckOutDate = new Date(checkInDate);
                minCheckOutDate.setDate(minCheckOutDate.getDate() + 1); // 최소 1박 이후 가능
                let minCheckOutStr = minCheckOutDate.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm 형식

                checkOutInput.min = minCheckOutStr;

                // 체크아웃 날짜가 체크인 날짜보다 이전이면 자동 변경
                let selectedCheckOutDate = new Date(checkOutInput.value);
                if (selectedCheckOutDate < minCheckOutDate) {
                    checkOutInput.value = minCheckOutStr;
                }
            }

            calculateStayAndPrice(); // 숙박일 및 총 비용 계산
        }

        // 체크아웃 날짜 선택 시 체크인 이후인지 검증
        function validateCheckOutDate() {
            const checkInInput = document.getElementById("checkInDate");
            const checkOutInput = document.getElementById("checkOutDate");

            let checkInDate = new Date(checkInInput.value);
            let checkOutDate = new Date(checkOutInput.value);

            if (!isNaN(checkInDate.getTime()) && !isNaN(checkOutDate.getTime()) && checkOutDate <= checkInDate) {
                let minCheckOutDate = new Date(checkInDate);
                minCheckOutDate.setDate(minCheckOutDate.getDate() + 1);
                checkOutInput.value = minCheckOutDate.toISOString().slice(0, 16);
            }

            calculateStayAndPrice(); // 숙박일 및 총 비용 계산
        }

        document.getElementById("checkInDate").addEventListener("change", updateCheckOutMinDate);
        document.getElementById("checkOutDate").addEventListener("change", validateCheckOutDate);

        // 페이지 로드 시 체크아웃 최소값 설정
        updateCheckOutMinDate();

        /* 체크인 & 체크아웃 날짜 변경 시 자동으로 숙박일과 총 금액 계산*/
        function calculateStayAndPrice() {
            const checkInInput = document.getElementById("checkInDate");
            const checkOutInput = document.getElementById("checkOutDate");
            const totalPriceInput = document.getElementById("totalPrice");
            const dayCountInput = document.getElementById("dayCount");

            // 값이 비어있는 경우 처리
            if (!checkInInput.value || !checkOutInput.value) {
                console.warn("체크인 또는 체크아웃 날짜가 비어 있음");
                dayCountInput.value = "";
                totalPriceInput.value = "";
                return;
            }

            const checkInDate = new Date(checkInInput.value);
            const checkOutDate = new Date(checkOutInput.value);

            // 날짜 변환이 실패한 경우 처리
            if (isNaN(checkInDate.getTime()) || isNaN(checkOutDate.getTime())) {
                console.error("유효하지 않은 날짜 값:", checkInInput.value, checkOutInput.value);
                return;
            }

            // 체크아웃이 체크인 이전이면 에러 방지
            if (checkOutDate <= checkInDate) {
                console.warn("체크아웃 날짜가 체크인 날짜보다 이전입니다.");
                dayCountInput.value = "";
                totalPriceInput.value = "";
                return;
            }

            const stayDays = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24)); // 일 단위 계산
            dayCountInput.value = `${stayDays}박 ${stayDays + 1}일`;

            // 객실 가격 가져오기
            let roomPriceElement = document.getElementById("roomPrice");
            let roomPrice = roomPriceElement && roomPriceElement.value ? parseInt(roomPriceElement.value.replace(/[^\d]/g, ""), 10) : null;

            if (!isNaN(roomPrice) && roomPrice !== null) {
                const totalPrice = roomPrice * stayDays;
                totalPriceInput.value = totalPrice.toLocaleString() + " KRW";
            } else {
                totalPriceInput.value = "가격 미정";
            }

            console.log("✔ 숙박일:", stayDays, "✔ 총 금액:", totalPriceInput.value);
        }

        /* roomID 검증 */
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("confirmReservation").addEventListener("click", function () {
                let roomId = parseInt(document.getElementById("roomId").value, 10);
                let checkInDate = document.getElementById("checkInDate").value;
                let checkOutDate = document.getElementById("checkOutDate").value;
                let count = parseInt(document.getElementById("reservationCount").value, 10);

                console.log("DEBUG: roomId =", roomId);
                console.log("DEBUG: checkInDate =", checkInDate);
                console.log("DEBUG: checkOutDate =", checkOutDate);
                console.log("DEBUG: count =", count);

                if (!roomId || !checkInDate || !checkOutDate || !count) {
                    alert("예약 정보를 모두 입력해주세요.");
                    return;
                }

                fetch("/reservation/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        roomId: roomId,
                        checkInDate: checkInDate,
                        checkOutDate: checkOutDate,
                        count: count
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log("DEBUG: 서버 응답 =", data);
                        if (data.success) {
                            alert("예약이 완료되었습니다!");
                            location.reload();
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => console.error("예약 요청 중 오류 발생:", error));
            });
        });

        // 예약 상태 업데이트 함수
        function updateRoomReservationStatus(parentElement = document) {
            const today = new Date();

            parentElement.querySelectorAll('.room-card').forEach(roomCard => {
                const stayEnd = roomCard.dataset.stayEnd;

                // stayEnd 값이 유효한지 확인
                if (!stayEnd) {
                    console.warn(`Invalid stayEnd for roomCard: ${roomCard}`);
                    return;
                }

                const reservationEndDate = new Date(stayEnd);

                // 예약기간이 지난 경우에만 표시
                if (reservationEndDate < today) {
                    const overlay = roomCard.querySelector('.sold-out-overlay');
                    if (overlay) {
                        overlay.style.display = 'flex';
                    }

                    // 예약 불가 버튼 처리
                    const button = roomCard.querySelector('.btn-book');
                    button.textContent = '예약 불가';
                    button.disabled = true;
                    button.classList.remove('btn-dark');
                    button.classList.add('btn-danger', 'text-bold');
                }
            });
        }

        // 모달 닫힐 때 강제 초기화
        document.getElementById('reservationModal').addEventListener('hidden.bs.modal', function () {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        });

        /* aria-hidden 제거 코드 */
        document.addEventListener("DOMContentLoaded", function () {
            var reservationModal = document.getElementById("reservationModal");

            // 모달 열릴 때 aria-hidden 제거
            reservationModal.addEventListener("shown.bs.modal", function () {
                console.log("Modal opened - removing aria-hidden");
                reservationModal.removeAttribute("aria-hidden");

                // 모달 내부 포커스를 강제 설정 (접근성 문제 해결)
                setTimeout(() => {
                    let focusableElement = reservationModal.querySelector("input, button, select, textarea");
                    if (focusableElement) {
                        focusableElement.focus();
                    }
                }, 100);
            });

            // 모달 닫힐 때 aria-hidden 추가
            reservationModal.addEventListener("hidden.bs.modal", function () {
                console.log("Modal closed - setting aria-hidden=true");
                reservationModal.setAttribute("aria-hidden", "true");
            });

            // Bootstrap 모달 초기화
            let modalInstance = bootstrap.Modal.getInstance(reservationModal);
            if (!modalInstance) {
                new bootstrap.Modal(reservationModal);
            }
        });

        /* 예약된 날짜 목록 가져와서 비활성화된 날짜 리스트로 변환 */
        function getDisabledDates(data) {
            let disabledDates = [];
            data.forEach(reservation => {
                let start = new Date(reservation.checkIn);
                let end = new Date(reservation.checkOut);
                while (start < end) {
                    disabledDates.push(start.toISOString().split("T")[0]); // YYYY-MM-DD 형식
                    start.setDate(start.getDate() + 1);
                }
            });
            return disabledDates;
        }

        /* flatpickr 함수 */
        document.addEventListener("DOMContentLoaded", function () {
            let reservationInput = document.getElementById("reservationDates");
            let checkInInput = document.getElementById("checkInDate");
            let checkOutInput = document.getElementById("checkOutDate");
            let roomId = document.getElementById("roomId")?.value || null;
            let reservationPicker = null; // flatpickr 인스턴스 저장 변수

            if (!reservationInput || !checkInInput || !checkOutInput || !roomId) {
                console.error(" ERROR: 필요한 요소를 찾을 수 없습니다!");
                return;
            }

            function initFlatpickr() {
                fetch(`/reservation/booked-dates/${roomId}`)
                    .then(response => response.json())
                    .then(data => {
                        let disabledDates = [];
                        data.forEach(reservation => {
                            let start = new Date(reservation.checkIn);
                            let end = new Date(reservation.checkOut);
                            while (start < end) {
                                disabledDates.push(start.toISOString().split("T")[0]); // YYYY-MM-DD 형식
                                start.setDate(start.getDate() + 1);
                            }
                        });

                        if (reservationPicker) {
                            reservationPicker.destroy();
                        }

                        reservationInput.removeAttribute("readonly");

                        reservationPicker = flatpickr("#reservationDates", {
                            mode: "range",
                            dateFormat: "Y-m-d",
                            minDate: "today",
                            disable: disabledDates,
                            locale: "ko",
                            onClose: function (selectedDates) {
                                if (selectedDates.length === 2) {
                                    let checkInDateFormatted = flatpickr.formatDate(selectedDates[0], "Y-m-d") + "T11:00";
                                    let checkOutDateFormatted = flatpickr.formatDate(selectedDates[1], "Y-m-d") + "T10:00";

                                    console.log(" 선택된 체크인 날짜:", checkInDateFormatted);
                                    console.log(" 선택된 체크아웃 날짜:", checkOutDateFormatted);

                                    checkInInput.value = checkInDateFormatted;
                                    checkOutInput.value = checkOutDateFormatted;
                                    calculateStayAndPrice();
                                } else {
                                    console.warn("️ 날짜 선택이 부족합니다.");
                                }
                            }
                        });
                    })
                    .catch(error => console.error(" 예약된 날짜 불러오기 실패:", error));
            }

            function fetchBookedDates() {
                fetch(`/reservation/booked-dates/${roomId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(" 예약된 날짜 리스트 (API 응답):", data);

                        let disabledDates = (Array.isArray(data) && data.length > 0) ? getDisabledDates(data) : [];

                        console.log(" 비활성화할 날짜 리스트:", disabledDates);

                        // 예약된 날짜가 없어도 Flatpickr를 실행하도록 설정
                        initFlatpickr(disabledDates);
                    })
                    .catch(error => {
                        console.error("️ 예약된 날짜를 불러오는 중 오류 발생:", error);
                        initFlatpickr([]); // 오류 발생 시에도 Flatpickr 실행
                    });
            }

            // 모달이 열릴 때 Flatpickr 적용
            document.getElementById("reservationModal").addEventListener("shown.bs.modal", function () {
                fetchBookedDates();
            });
        });

        /* 리뷰 함수 */
        document.addEventListener("DOMContentLoaded", function () {
            console.log("JavaScript 초기화됨!");

            const roomId = getRoomIdFromURL();
            const memberId = document.getElementById("reviewMemberId")?.value || null;
            const reviewList = document.getElementById("reviewList");
            const loadMoreButton = document.createElement("button");

            let currentPage = 0;
            const pageSize = 10;

            loadMoreButton.textContent = "More";
            loadMoreButton.classList.add("mt-3", "real-more");
            loadMoreButton.style.display = "none";
            loadMoreButton.style.textAlign = "center";
            reviewList.after(loadMoreButton);


            /* 리뷰 목록 불러오기 */
            function loadReviews() {
                fetch(`/reviews/room/${roomId}?page=${currentPage}&size=${pageSize}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("DEBUG: 리뷰 API 응답 데이터 =", data);

                        const reviewList = document.getElementById("reviewList");
                        const noReviewMessage = document.getElementById("noReviewMessage");

                        //  리뷰 데이터가 없는 경우 "등록된 후기가 없습니다." 메시지를 표시
                        if (!data.content || data.content.length === 0) {
                            noReviewMessage.style.display = "block";
                            loadMoreButton.style.display = "none";
                            return;
                        } else {
                            noReviewMessage.style.display = "none";
                        }

                        data.content.forEach(review => {
                            console.log("reviewId =", review.reviewId);

                            const reviewItem = document.createElement("div");
                            reviewItem.classList.add("border", "p-3", "mb-3", "rounded");
                            reviewItem.setAttribute("data-review-id", review.reviewId);
                            reviewItem.setAttribute("data-review-text", review.reviewText);
                            reviewItem.setAttribute("data-review-rating", review.rating);
                            // 별점 클래스 추가
                            let ratingClass = `rating-${review.rating}`;

                            // 본인 리뷰인 경우 수정/삭제 버튼 추가
                            let actionButtons = "";
                            if (memberId && memberId == review.memberId) {
                                actionButtons = `
                                <button class="btn btn-sm btn-outline-primary edit-review-btn"
                                        data-review-id="${review.reviewId}"
                                        data-review-text="${review.reviewText}"
                                        data-review-rating="${review.rating}">수정</button>
                                <button class="btn btn-sm btn-outline-danger delete-review-btn"
                                        data-review-id="${review.reviewId}">삭제</button>
                            `;
                            }

                            reviewItem.innerHTML = `
                                <div class="review-meta">
                                    <p><strong>${review.memberName || "익명"}</strong> -
                                        <span class="star-rating ${ratingClass}">${"★".repeat(review.rating)}${"☆".repeat(5 - review.rating)}</span>
                                    </p>
                                    <p class="text-muted small review-date">${new Date(review.reviewDate).toLocaleString()}</p>
                                </div>
                                <p>${review.reviewText}</p>
                                <div>${actionButtons}</div>
                            `;
                            reviewList.appendChild(reviewItem);
                        });

                        // 현재 페이지 증가
                        currentPage++;

                        // 마지막 페이지일 경우 "더 보기" 버튼 숨김
                        if (data.last) {
                            loadMoreButton.style.display = "none";
                        } else {
                            loadMoreButton.style.display = "block";
                        }

                        // 수정 및 삭제 버튼 이벤트 추가
                        document.querySelectorAll(".edit-review-btn").forEach(button =>
                            button.addEventListener("click", openEditReviewModal)
                        );
                        document.querySelectorAll(".delete-review-btn").forEach(button =>
                            button.addEventListener("click", deleteReview)
                        );
                    })
                    .catch(error => console.error("리뷰 불러오기 오류:", error));
            }

            // "더 보기" 버튼 클릭 이벤트
            loadMoreButton.addEventListener("click", function () {
                loadReviews();
            });

            // 초기 리뷰 5개 불러오기
            loadReviews();

            /* 리뷰 수정 모달 열기 */
            function openEditReviewModal(event) {
                const button = event.currentTarget;
                let reviewId = button.getAttribute("data-review-id");
                let reviewText = button.getAttribute("data-review-text");
                let reviewRating = button.getAttribute("data-review-rating");

                console.log(" 수정할 리뷰 정보:", reviewId, reviewText, reviewRating);

                document.getElementById("editReviewId").value = reviewId;
                document.getElementById("editReviewText").value = reviewText;
                document.getElementById("editRating").value = reviewRating;

                const editReviewModal = new bootstrap.Modal(document.getElementById("editReviewModal"));
                editReviewModal.show();
            }

            /* 리뷰 삭제 요청 */
            function deleteReview(event) {
                const reviewId = event.currentTarget.getAttribute("data-review-id");

                if (!confirm("정말로 이 리뷰를 삭제하시겠습니까?")) {
                    return;
                }

                fetch(`/reviews/delete/${reviewId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("리뷰가 삭제되었습니다!");
                            location.reload();
                        } else {
                            alert("리뷰 삭제 실패: " + data.message);
                        }
                    })
                    .catch(error => console.error("리뷰 삭제 오류:", error));
            }

            /* 리뷰 등록 요청 */
            document.getElementById("submitReview").addEventListener("click", function () {
                const roomId = getRoomIdFromURL();
                const memberId = document.getElementById("reviewMemberId")?.value || null;
                const reviewList = document.getElementById("reviewList");
                const reviewText = document.getElementById("reviewText").value;
                const rating = document.getElementById("rating").value;

                if (!memberId) {
                    alert("로그인이 필요합니다.");
                    window.location.href = "/login";
                    return;
                }

                if (!rating || rating < 1 || rating > 5) {
                    alert("별점을 선택해주세요!");
                    return;
                }

                if (!reviewText) {
                    alert("리뷰 내용을 입력해주세요.");
                    return;
                }

                fetch("/reviews/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ roomId, memberId, rating, reviewText })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("리뷰가 등록되었습니다!");

                            // 입력 폼 초기화
                            document.getElementById("reviewForm").reset();

                            // 최신 리뷰 추가
                            addReviewToList(data.reviewId, data.memberName || "익명", reviewText, rating);

                            // "등록된 후기가 없습니다." 메시지가 있으면 숨김
                            document.getElementById("noReviewMessage").style.display = "none";
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => console.error("리뷰 등록 오류:", error));
            });

            /* 새 리뷰를 추가하는 함수 */
            function addReviewToList(reviewId, memberName, reviewText, rating) {
                const reviewList = document.getElementById("reviewList");

                const newReviewItem = document.createElement("div");
                newReviewItem.classList.add("border", "p-3", "mb-3", "rounded");
                newReviewItem.setAttribute("data-review-id", reviewId);
                newReviewItem.setAttribute("data-review-text", reviewText);
                newReviewItem.setAttribute("data-review-rating", rating);

                let actionButtons = `
                        <button class="btn btn-sm btn-outline-primary edit-review-btn"
                                data-review-id="${reviewId}"
                                data-review-text="${reviewText}"
                                data-review-rating="${rating}">수정</button>
                        <button class="btn btn-sm btn-outline-danger delete-review-btn"
                                data-review-id="${reviewId}">삭제</button>
                    `;

                newReviewItem.innerHTML = `
                        <div class="review-meta">
                            <p><strong>${memberName}</strong> -
                                <span class="star-rating rating-${rating}">${"★".repeat(rating)}${"☆".repeat(5 - rating)}</span>
                            </p>
                            <p class="text-muted small review-date">${new Date().toLocaleString()}</p>
                        </div>
                        <p>${reviewText}</p>
                        <div>${actionButtons}</div>
                    `;

                // 최신 리뷰를 목록 맨 앞에 추가
                reviewList.prepend(newReviewItem);

                // 수정 및 삭제 버튼 이벤트 추가
                newReviewItem.querySelector(".edit-review-btn").addEventListener("click", openEditReviewModal);
                newReviewItem.querySelector(".delete-review-btn").addEventListener("click", deleteReview);

            }

            /* 리뷰 개수 확인 후 `loadMoreButton` 업데이트 */
            function updateLoadMoreButton() {
                let reviewItems = document.querySelectorAll("#reviewList .border");
                console.log("현재 리뷰 개수:", reviewItems.length);

                if (reviewItems.length >= pageSize) {
                    loadMoreButton.style.display = "block"; // 더 보기 버튼 표시
                } else {
                    loadMoreButton.style.display = "none"; // 숨김
                }
            }

            /* URL에서 roomId 가져오기 */
            function getRoomIdFromURL() {
                const pathSegments = window.location.pathname.split("/");
                return pathSegments[pathSegments.length - 1];
            }
        });


        /* 리뷰 수정요청 함수 */
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".edit-review-btn").forEach(button => {
                button.addEventListener("click", openEditReviewModal);
            });

            // 리뷰 수정 완료 버튼 클릭 시 saveReviewChanges 실행
            document.getElementById("saveReviewChanges").addEventListener("click", function () {
                const reviewId = document.getElementById("editReviewId").value;
                const reviewText = document.getElementById("editReviewText").value;
                const rating = document.getElementById("editRating").value;

                fetch(`/reviews/update/${reviewId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ reviewText, rating })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("리뷰가 수정되었습니다!");
                            location.reload();
                        } else {
                            alert("리뷰 수정 실패: " + data.message);
                        }
                    })
                    .catch(error => console.error("리뷰 수정 오류:", error));
            });
        });

        /* 리뷰 별점 선택 함수 */
        document.addEventListener("DOMContentLoaded", function () {
            const stars = document.querySelectorAll("#star-rating .star");
            const ratingInput = document.getElementById("rating");
            let selectedRating = parseInt(ratingInput.value) || 5;

            highlightStars(selectedRating); // 페이지 로드 시 초기 별점 반영

            //  마우스를 올렸을 때 해당 별과 왼쪽 별 모두 색칠
            stars.forEach((star, index) => {
                star.addEventListener("mouseover", function () {
                    highlightStars(index + 1);
                });

                //  마우스를 벗어나면 기존 선택한 별만 유지
                star.addEventListener("mouseleave", function () {
                    highlightStars(selectedRating);
                });

                //  클릭하면 해당 별점이 고정됨
                star.addEventListener("click", function () {
                    selectedRating = index + 1;
                    ratingInput.value = selectedRating;
                    highlightStars(selectedRating);
                    console.log(" 선택된 별점:", selectedRating);
                });
            });

            //  별점 색칠 함수
            function highlightStars(count) {
                stars.forEach((star, index) => {
                    if (index < count) {
                        star.classList.add("selected");
                    } else {
                        star.classList.remove("selected");
                    }
                });
            }
        });

        /* 스크롤 최상단 이동 버튼 */
        document.addEventListener("DOMContentLoaded", function () {
            const scrollTopButton = document.getElementById("scrollTopButton");

            // 스크롤 이벤트 감지
            window.addEventListener("scroll", function () {
                if (window.scrollY > 500) {
                    scrollTopButton.classList.add("show");
                } else {
                    scrollTopButton.classList.remove("show");
                }
            });

            // 버튼 클릭 시 최상단으로 이동
            scrollTopButton.addEventListener("click", function () {
                window.scrollTo({ top: 0, behavior: "smooth" });
            });
        });

    </script>
</div>
<div th:replace="~{fragments/footer::footer}"></div>
</body>
</html>