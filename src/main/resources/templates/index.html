<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head>
    <meta charset="UTF-8">
    <title>NTT호텔</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/user.css}">
    <link rel="stylesheet" th:href="@{/css/map.css}">
</head>
<body>
<div th:replace="~{fragments/header::header}"></div>
<!--본문-->
<div layout:fragment="content">
    <!-- 배너 -->
    <section class="text-center bg-light">
        <div id="bannerCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
            <div class="bnr_wrapper carousel-inner">
                <div class="carousel-item active">
                    <img src="/img/bg_wedding.jpg" class="d-block w-100" alt="Wedding">
                </div>
                <div class="carousel-item">
                    <img src="/img/bg_dining.jpg" class="d-block w-100" alt="Dining">
                </div>
                <div class="carousel-item">
                    <img src="/img/bg_membership.jpg" class="d-block w-100" alt="Membership">
                </div>
                <div class="carousel-item">
                    <img src="/img/bg_activity.jpg" class="d-block w-100" alt="Activity">
                </div>
            </div>
            <!-- 슬라이드 버튼 -->
            <button class="carousel-control-prev" type="button" data-bs-target="#bannerCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#bannerCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
            <!-- 슬라이드 인디케이터 -->
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="3" aria-label="Slide 4"></button>
            </div>
        </div>
    </section>

    <!-- 추천 룸 섹션 -->
    <section class="py-5">
        <div class="container">
            <!-- 섹션 제목과 More 버튼 배치 -->
            <div class="d-flex justify-content-between align-items-center mb-5 recommended-wrap">
                <h2 class="text-center flex-grow-1">Recommended room</h2>
                <a href="/roomList" class="btn btn-outline-primary ms-auto more-btn">More</a>
            </div>

            <!-- 추천 방이 있을 경우 -->
            <div th:if="${recommendedRooms != null and !#lists.isEmpty(recommendedRooms)}" class="row">
                <div class="col-md-3" th:each="room : ${recommendedRooms}">
                    <div class="card image-hover-container">
                        <div class="image-container">
                            <!-- 이미지 -->
                            <img th:if="${!#lists.isEmpty(room.roomImageDTOList)}"
                                 th:src="@{'/upload/' + ${room.roomImageDTOList[0].imagePath}}"
                                 class="card-img-top"
                                 th:alt="${room.roomName}" />
                            <!-- 이미지가 없을 경우 기본 이미지 -->
                            <img th:if="${#lists.isEmpty(room.roomImageDTOList)}"
                                 src="/img/default_img.jpg"
                                 class="card-img-top"
                                 alt="Default Room Image" />
                            <!-- Hover 시 나타나는 예약 버튼 -->
                            <div class="hover-overlay">
                                <a href="#" class="btn btn-hover">예약하기</a>
                            </div>
                        </div>
                        <div class="card-body text-left">
                            <!-- 상태 버튼 -->
                            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                <span th:text="(${room.roomStatus} ? '예약 가능' : '예약 불가')"
                                      class="badge"
                                      th:classappend="${room.roomStatus} ? 'bg-success text-white' : 'bg-danger text-white'">
                                </span>
                                <!-- 객실 타입 버튼 -->
                                <span th:text="${room.roomType}"
                                      class="badge bg-dark text-white">
                                </span>
                            </div>
                            <h5 th:text="${room.roomName}" class="card-title">객실 이름</h5>
                            <p th:text="'예약 기간: ' + ${room.reservationStart} + ' ~ ' + ${room.reservationEnd}" class="card-text">예약 기간</p>
                            <p th:text="'숙박 기간: ' + ${room.stayStart} + ' ~ ' + ${room.stayEnd}" class="card-text">숙박 기간</p>
                            <p th:text="${room.formattedRoomPrice} + ' ' " class="card-text money"> 0 KRW</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 추천 방이 없을 경우 -->
            <div th:if="${recommendedRooms == null or #lists.isEmpty(recommendedRooms)}" class="text-center mt-4">
                <p class="text-muted">추천 방 목록이 없습니다.</p>
            </div>
        </div>
    </section>

    <!-- 지도 섹션 -->
    <section class="text-center py-5 bg-light">

        <h2>가까운 호텔 찾기</h2>

        <div class="container">
            <div class="bg-secondary text-white d-flex justify-content-center" style="height: 500px;">
                <div class="map_wrap">
                    <div id="map" style="width:100%;height:100%;position:relative;overflow:hidden;"></div>
                    <!-- 지도타입 컨트롤 div 입니다 -->
                    <div class="custom_typecontrol radius_border">
                        <span id="btnRoadmap" class="selected_btn" onclick="setMapType('roadmap')">지도</span>
                        <span id="btnSkyview" class="btn" onclick="setMapType('skyview')">스카이뷰</span>
                    </div>
                    <!-- 지도 확대, 축소 컨트롤 div 입니다 -->
                    <div class="custom_zoomcontrol radius_border">
                        <span onclick="zoomIn()"><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_plus.png" alt="확대"></span>
                        <span onclick="zoomOut()"><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_minus.png" alt="축소"></span>
                    </div>
                </div>
                <script type="text/javascript"
                        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=0cb0450151c2b892da76c0d5dcd6535a&libraries=services"></script>
                <script>
                    var infowindow = new kakao.maps.InfoWindow({zIndex:1});
                    var mapContainer = document.getElementById('map');
                    var mapOption = {
                        center: new kakao.maps.LatLng(37.566826, 126.9786567),
                        level: 5
                    };

                    var map = new kakao.maps.Map(mapContainer, mapOption);
                    var ps = new kakao.maps.services.Places();
                    var myLocationMarker = null;

                    // 지도 타입 일반지도, 스카이뷰 선택 기능
                    function setMapType(maptype) {
                        var roadmapControl = document.getElementById('btnRoadmap');
                        var skyviewControl = document.getElementById('btnSkyview');
                        if (maptype === 'roadmap') {
                            map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
                            roadmapControl.className = 'selected_btn';
                            skyviewControl.className = 'btn';
                        } else {
                            map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
                            skyviewControl.className = 'selected_btn';
                            roadmapControl.className = 'btn';
                        }
                    }

                    // 지도 확대 기능
                    function zoomIn() {
                        map.setLevel(map.getLevel() - 1);
                    }

                    // 지도 축소 기능
                    function zoomOut() {
                        map.setLevel(map.getLevel() + 1);
                    }

                    // 검색 결과 마커 표시 기능
                    function displayMarker(place) {
                        var marker = new kakao.maps.Marker({
                            map: map,
                            position: new kakao.maps.LatLng(place.y, place.x)
                        });

                        kakao.maps.event.addListener(marker, 'click', function() {
                            if (infowindow.getMap()) {
                                infowindow.close();
                            } else {
                                infowindow.setContent('<div style="padding:5px;font-size:12px; color:black;">' + place.place_name + '</div>');
                                infowindow.open(map, marker);
                            }
                        });

                        kakao.maps.event.addListener(map, 'click', function() {
                            if (infowindow.getMap()) {
                                infowindow.close();
                            }
                        });
                    }

                    // 내 위치 표시 기능
                    function showMyLocation() {
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(function(position) {
                                var lat = position.coords.latitude;
                                var lng = position.coords.longitude;
                                var myPosition = new kakao.maps.LatLng(lat, lng);

                                if (myLocationMarker) {
                                    myLocationMarker.setMap(null);
                                }

                                myLocationMarker = new kakao.maps.Marker({
                                    map: map,
                                    position: myPosition,
                                    image: new kakao.maps.MarkerImage(
                                        'https://t1.daumcdn.net/localimg/localimages/07/2018/mw/m640/ico_marker.png',
                                        new kakao.maps.Size(30, 30),
                                        { offset: new kakao.maps.Point(0, 0) }
                                    )
                                });

                                map.setCenter(myPosition);

                                // 내 위치를 기준으로 검색 실행
                                searchNearbyPlaces1(lat, lng);
                                searchNearbyPlaces2(lat, lng);

                            }, function(error) {
                                alert('위치 정보를 가져올 수 없습니다.');
                            });
                        } else {
                            alert('이 브라우저에서는 Geolocation을 지원하지 않습니다.');
                        }
                    }

                    // 내 위치를 기반으로 검색 기능 1
                    function searchNearbyPlaces1(lat, lng) {
                        var searchOption = {
                            location: new kakao.maps.LatLng(lat, lng),
                            radius: 5000 // 내 위치에서 반경 5km 범위 검색(미터단위)
                        };

                        ps.keywordSearch('호텔', placesSearchCB, searchOption);
                    }

                    function searchNearbyPlaces2(lat, lng) {
                        var searchOption = {
                            location: new kakao.maps.LatLng(lat, lng),
                            radius: 5000 // 내 위치에서 반경 5km 범위 검색(미터단위)
                        };

                        ps.keywordSearch('모텔', placesSearchCB, searchOption);
                    }

                    // 내 위치를 기반으로 검색 기능 2
                    function placesSearchCB(data, status, pagination) {
                        if (status === kakao.maps.services.Status.OK) {
                            var bounds = new kakao.maps.LatLngBounds();
                            for (var i = 0; i < data.length; i++) {
                                displayMarker(data[i]);
                                bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
                            }
                            map.setBounds(bounds);
                        }
                    }

                    // 페이지 로드 시 내 위치 표시
                    showMyLocation();
                </script>
            </div>
        </div>
    </section>

    <!-- 회원 탈퇴 성공 모달창 -->
    <div th:if="${successMessage}" class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">회원탈퇴 완료</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p th:text="${successMessage}">회원탈퇴가 완료되었습니다.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{fragments/footer::footer}"></div>

<script th:inline="javascript">
    /* 회원 탈퇴 성공 모달창을 띄워주는 스크립트 */
    var successMessage = /*[[${successMessage}]]*/ '';
    if (successMessage) {
        var myModal = new bootstrap.Modal(document.getElementById('successModal'), {
            keyboard: false
        });
        myModal.show();
    }
</script>

</body>
</html>